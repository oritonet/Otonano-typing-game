<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>
漢字変換対応の日本語タイピング練習｜雑学・豆知識で実務入力を鍛える（IME評価・ランキング対応）
</title>

<style>
body{font-family:"Noto Sans JP",system-ui;margin:0;background:#fafafa}
header,main,footer{max-width:980px;margin:auto;padding:16px}
.card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px}
#text{background:#f3f3f3;padding:14px;border-radius:10px;font-size:1.25em;white-space:pre-wrap}
.ok{color:#0b5ed7;font-weight:bold}
.ng{color:#c00000;font-weight:bold}
textarea{width:100%;min-height:180px;font-size:1.25em;padding:12px;border-radius:10px}
button{padding:10px 14px;border-radius:10px}
</style>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore,collection,addDoc,serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth,signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
 apiKey:"AIzaSyAqDSPE_HkPbi-J-SqPL4Ys-wR4RaA8wKA",
 authDomain:"otonano-typing-game.firebaseapp.com",
 projectId:"otonano-typing-game"
});
const db = getFirestore(app);
signInAnonymously(getAuth(app));

/* ========= 状態 ========= */
let items=[];
let target="";
let startTime=0;
let keystrokes=0;
let composing=false;
let dailyTheme="";

/* ========= データ ========= */
async function loadData(){
 const r=await fetch("./data/trivia.json");
 items=await r.json();

 // 今日のテーマ固定
 const themes=[...new Set(items.map(x=>x.theme))];
 const d=new Date().toISOString().slice(0,10);
 dailyTheme=themes[Math.abs(hash(d))%themes.length];

 nextText();
}

function hash(s){let h=0;for(let c of s)h=(h<<5)-h+c.charCodeAt(0);return h}

/* ========= 出題 ========= */
function nextText(){
 const pool=items.filter(x=>x.theme===dailyTheme);
 const pick=pool[Math.floor(Math.random()*pool.length)];
 target=pick.text;
 document.getElementById("text").textContent=target;
 document.getElementById("input").value="";
}

/* ========= 描画 ========= */
function render(typed){
 if(composing) return; // ★②修正：変換中は保持
 let html="";
 for(let i=0;i<target.length;i++){
  if(i<typed.length){
   html+=typed[i]===target[i]
    ? `<span class="ok">${target[i]}</span>`
    : `<span class="ng">${target[i]}</span>`;
  }else html+=target[i];
 }
 document.getElementById("text").innerHTML=html;
}

/* ========= カウントダウン（②） ========= */
async function startTyping(){
 const ta=document.getElementById("input");
 ta.disabled=false;
 ta.readOnly=true;
 ta.style.textAlign="center";
 ta.style.fontSize="2rem";

 for(const s of ["3","2","1","START"]){
  ta.value=s;
  await new Promise(r=>setTimeout(r,700));
 }

 ta.value="";
 ta.readOnly=false;
 ta.style.textAlign="";
 ta.style.fontSize="";
 ta.focus();

 startTime=0;
 keystrokes=0;
}

/* ========= 評価 ========= */
function finish(){
 const sec=(Date.now()-startTime)/1000;
 const min=sec/60;
 const cpm=Math.round(target.length/min);
 const kpm=Math.round(keystrokes/min);
 const eff=(cpm/kpm*100).toFixed(1);
 const rank=cpm>400?"SSS":cpm>300?"S":cpm>200?"A":"B";

 alert(
  `完了！\n\n`+
  `ランク：${rank}\n`+
  `CPM：${cpm}\n`+
  `KPM：${kpm}\n`+
  `効率：${eff}%`
 );

 // ★④修正：今日のテーマ専用コレクションにのみ保存
 addDoc(
  collection(db,"scores__daily__"+dailyTheme),
  {
   cpm,kpm,rank,
   theme:dailyTheme,
   timestamp:serverTimestamp()
  }
 );

 nextText();
 startTime=0;
}

/* ========= メイン ========= */
window.addEventListener("DOMContentLoaded",()=>{
 const ta=document.getElementById("input");

 ta.addEventListener("compositionstart",()=>composing=true);
 ta.addEventListener("compositionend",()=>composing=false);

 ta.addEventListener("keydown",e=>{
  if(["Backspace","Delete","Enter"," "].includes(e.key)||e.key.length===1)
   keystrokes++;
 });

 ta.addEventListener("input",()=>{
  if(!startTime&&ta.value.length>0){
   startTime=Date.now();
   keystrokes=0;
  }
  render(ta.value);

  // ★③修正：完全一致した瞬間に終了
  if(
   ta.value.length===target.length &&
   ta.value===target
  ){
   finish();
  }
 });

 document.getElementById("startBtn").onclick=startTyping;

 loadData();
});
</script>
</head>

<body>
<header>
<h1>漢字変換対応 日本語タイピング練習</h1>
<p id="today">今日のテーマ：固定</p>
</header>

<main>
<section class="card">
<button id="startBtn">スタート</button>
<p id="text">読み込み中…</p>
<textarea id="input" disabled></textarea>
</section>
</main>

<footer>
<p>© 2025</p>
</footer>
</body>
</html>
