<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>漢字変換対応の日本語タイピング練習｜雑学・豆知識で実務入力を鍛える（IME評価・ランキング対応）</title>
<meta name="description" content="漢字変換を含む日本語IME入力をCPM・KPMで精密評価。雑学・豆知識文章で知識と実務入力力を同時に鍛える無料タイピング練習。日替わりテーマ・カテゴリ別ランキング・個人履歴・分析対応。">

<link rel="canonical" href="https://espresso-taro.github.io/Otonano-typing-game/">

<style>
:root { --max:980px; }
body{margin:0;font-family:system-ui,"Noto Sans JP";background:#fafafa;line-height:1.85}
header,main,footer{max-width:var(--max);margin:auto;padding:16px}
.card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px}
h1{margin-top:0}
select,button,input,textarea{font-size:1rem;padding:10px;border-radius:10px;border:1px solid #bbb}
button{cursor:pointer}
textarea{width:100%;min-height:180px;font-size:1.25em}
#text{background:#f3f3f3;padding:14px;border-radius:10px;font-size:1.25em;white-space:pre-wrap}
.ok{color:#0b5ed7;font-weight:bold}
.ng{color:#c00000;font-weight:bold}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eee;margin:4px;font-size:.9rem}
.hidden{display:none}
.countdown{font-size:2.5rem;font-weight:bold;text-align:center;margin:20px 0}
</style>

<script type="module">
/* ===============================
 Firebase
=============================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore,collection,addDoc,getDocs,query,orderBy,limit,serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth,signInAnonymously,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
 apiKey:"AIzaSyAqDSPE_HkPbi-J-SqPL4Ys-wR4RaA8wKA",
 authDomain:"otonano-typing-game.firebaseapp.com",
 projectId:"otonano-typing-game"
});
const db = getFirestore(app);
const auth = getAuth(app);
signInAnonymously(auth);

/* ===============================
 ユーザー管理（端末最大10名）
=============================== */
const USER_KEY="typing_users";
const LAST_USER_KEY="typing_last_user";
let users=JSON.parse(localStorage.getItem(USER_KEY)||"[]");
let currentUser=null;

function saveUsers(){
 localStorage.setItem(USER_KEY,JSON.stringify(users.slice(0,10)));
}
function selectUser(name){
 currentUser=name;
 localStorage.setItem(LAST_USER_KEY,name);
 renderUserSelect();
 loadMyHistory();
}
function renderUserSelect(){
 const sel=document.getElementById("userSelect");
 sel.innerHTML="";
 users.forEach(u=>{
  const o=document.createElement("option");
  o.value=u;o.textContent=u;
  if(u===currentUser)o.selected=true;
  sel.appendChild(o);
 });
}

/* ===============================
 タイピング評価
=============================== */
let target="";
let startTime=0;
let keystrokes=0;
let composing=false;

function renderText(typed){
 if(composing){
  document.getElementById("text").textContent=target;
  return;
 }
 let html="";
 for(let i=0;i<target.length;i++){
  if(i<typed.length){
   html+=typed[i]===target[i]
    ? `<span class="ok">${target[i]}</span>`
    : `<span class="ng">${target[i]}</span>`;
  }else html+=target[i];
 }
 document.getElementById("text").innerHTML=html;
}

function calcMetrics(typed,sec){
 const min=sec/60;
 const cpm=Math.round(typed.length/min);
 const kpm=Math.round(keystrokes/min);
 const eff=cpm/kpm;
 let rank="D";
 if(cpm>=420&&eff>=.92)rank="SSS";
 else if(cpm>=360&&eff>=.88)rank="SS";
 else if(cpm>=320&&eff>=.84)rank="S";
 else if(cpm>=260&&eff>=.78)rank="A";
 else if(cpm>=200&&eff>=.72)rank="B";
 else if(cpm>=150)rank="C";
 return {cpm,kpm,rank,eff};
}
function rankingScore(cpm,kpm){
 return Math.round(cpm + (cpm/kpm)*100 - (kpm-cpm)*.3);
}

/* ===============================
 出題
=============================== */
let items=[];
async function loadData(){
 const r=await fetch("./data/trivia.json");
 items=await r.json();
 nextText();
}
function nextText(){
 const i=Math.floor(Math.random()*items.length);
 target=items[i].text;
 document.getElementById("text").textContent=target;
 document.getElementById("input").value="";
}

/* ===============================
 カウントダウン開始
=============================== */
async function startTyping(){
 const cd=document.getElementById("countdown");
 cd.classList.remove("hidden");
 for(let i=3;i>=0;i--){
  cd.textContent=i===0?"START":i;
  await new Promise(r=>setTimeout(r,700));
 }
 cd.classList.add("hidden");
 document.getElementById("input").focus();
}

/* ===============================
 保存（自動）
=============================== */
async function saveScoreAuto(metrics){
 const score={
  name:currentUser,
  cpm:metrics.cpm,
  kpm:metrics.kpm,
  rank:metrics.rank,
  rankingScore:rankingScore(metrics.cpm,metrics.kpm),
  timestamp:serverTimestamp()
 };
 await addDoc(collection(db,"scores__overall"),score);
}

/* ===============================
 メイン
=============================== */
window.addEventListener("DOMContentLoaded",()=>{
 const sel=document.getElementById("userSelect");
 const last=localStorage.getItem(LAST_USER_KEY);
 if(last)currentUser=last;
 renderUserSelect();

 document.getElementById("addUser").onclick=()=>{
  const n=prompt("ユーザー名");
  if(!n)return;
  if(!users.includes(n)){users.unshift(n);saveUsers();}
  selectUser(n);
 };
 sel.onchange=e=>selectUser(e.target.value);

 const input=document.getElementById("input");
 input.addEventListener("compositionstart",()=>composing=true);
 input.addEventListener("compositionend",()=>composing=false);
 input.addEventListener("keydown",e=>{
  if(["Backspace","Delete","Enter"," "].includes(e.key)||e.key.length===1)
   keystrokes++;
 });
 input.addEventListener("input",()=>{
  if(!startTime&&input.value.length>0){
   startTime=Date.now();keystrokes=0;
  }
  renderText(input.value);
  if(input.value===target){
   const sec=(Date.now()-startTime)/1000;
   const m=calcMetrics(input.value,sec);
   document.getElementById("result").innerHTML=
    `CPM ${m.cpm} / KPM ${m.kpm} / Rank ${m.rank}`;
   saveScoreAuto(m);
   nextText();
   startTime=0;
  }
 });

 document.getElementById("startBtn").onclick=startTyping;
 loadData();
});
</script>
</head>

<body>
<header>
<h1>漢字変換対応 日本語タイピング練習</h1>
<p>IME変換を含む実務入力を、雑学・豆知識文章で鍛える。</p>

<div>
<select id="userSelect"></select>
<button id="addUser">ユーザー追加</button>
</div>
</header>

<main>
<section class="card">
<button id="startBtn">スタート</button>
<div id="countdown" class="countdown hidden"></div>

<p id="text">読み込み中…</p>
<textarea id="input" placeholder="ここに入力" disabled></textarea>
<div id="result"></div>
</section>
</main>

<footer>
<p>© 2025</p>
</footer>
</body>
</html>
