<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO -->
  <title>æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ï½œé›‘å­¦ãƒ»è±†çŸ¥è­˜ã§æ—¥æœ¬èªå…¥åŠ›ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œï¼‰</title>
  <meta name="description" content="æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨çš„ãªæ—¥æœ¬èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ãŒã§ãã‚‹ç„¡æ–™ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ•ãƒˆã€‚é›‘å­¦ãƒ»è±†çŸ¥è­˜ã‚’é¡Œæã«ã—ãŸæ–‡ç« ã§ã€å…¥åŠ›ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»æ­£ç¢ºæ€§ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‰ã‚Œã¾ã™ã€‚é›£æ˜“åº¦åˆ†ã‘ãƒ»æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œã€‚" />
  <link rel="canonical" href="https://espresso-taro.github.io/Otonano-typing-game/" />

  <!-- OGP -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ï½œé›‘å­¦ãƒ»è±†çŸ¥è­˜ã§æ—¥æœ¬èªå…¥åŠ›ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œï¼‰" />
  <meta property="og:description" content="é›‘å­¦ãƒ»è±†çŸ¥è­˜æ–‡ç« ã§æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã€‚é›£æ˜“åº¦åˆ†ã‘ãƒ»æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œã€‚" />
  <meta property="og:url" content="https://espresso-taro.github.io/Otonano-typing-game/" />
  <meta name="twitter:card" content="summary" />

  <style>
    :root { --max: 980px; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      margin: 0;
      line-height: 1.8;
      background: #fafafa;
    }
    header, main, footer {
      max-width: var(--max);
      margin: 0 auto;
      padding: 16px;
    }
    header { padding-top: 28px; }
    h1 { font-size: 1.9rem; margin: 0 0 10px; }
    h2 { margin-top: 34px; }
    .lead { font-size: 1.05rem; margin: 0 0 12px; }
    .muted { color: #555; }
    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .cta {
      display: inline-block;
      padding: 10px 14px;
      border: 1px solid #222;
      border-radius: 10px;
      text-decoration: none;
      color: inherit;
      background: #fff;
    }
    #text {
      font-size: 1.2em;
      background: #f3f3f3;
      padding: 10px;
      border-radius: 10px;
    }
    #input {
      width: 100%;
      font-size: 1.2em;
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    #result { margin-top: 10px; font-weight: 700; }
    #ranking li { margin-bottom: 4px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 0 0 auto; }
    #name {
      font-size: 1rem;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      min-width: 220px;
    }
    #submitBtn {
      font-size: 1rem;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #222;
      background: #fff;
      cursor: pointer;
    }
    select, label.checkbox {
      font-size: 0.95rem;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
    }
    label.checkbox {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #ccc;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      font-size: 0.9rem;
      margin: 0 6px 6px 0;
    }
    details {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }
    details + details { margin-top: 10px; }
    footer { padding-bottom: 28px; }
  </style>

  <!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼šWebSite -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’",
    "url":"https://espresso-taro.github.io/Otonano-typing-game/",
    "inLanguage":"ja",
    "description":"é›‘å­¦ãƒ»è±†çŸ¥è­˜æ–‡ç« ã§ã€æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨çš„ãªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã€‚é›£æ˜“åº¦åˆ†ã‘ãƒ»æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œã€‚"
  }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      orderBy, query, serverTimestamp, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyAqDSPE_HkPbi-J-SqPL4Ys-wR4RaA8wKA",
      authDomain: "otonano-typing-game.firebaseapp.com",
      projectId: "otonano-typing-game",
      storageBucket: "otonano-typing-game.appspot.com",
      messagingSenderId: "475283850178",
      appId: "1:475283850178:web:193d28f17be20a232f4c5b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== Difficulty rules (length ê¸°ë°˜) =====
    // ã“ã“ã¯å¾Œã§èª¿æ•´ã—ã‚„ã™ã„ã‚ˆã†ã«å®šæ•°åŒ–
    const EASY_MAX = 120;    // 120æ–‡å­—ä»¥ä¸‹
    const NORMAL_MAX = 150;  // 121ã€œ150æ–‡å­—
    // 151æ–‡å­—ä»¥ä¸Š = ã‚€ãšã‹ã—ã„

    function calcDifficulty(len) {
      if (len <= EASY_MAX) return "ã‹ã‚“ãŸã‚“";
      if (len <= NORMAL_MAX) return "ãµã¤ã†";
      return "ã‚€ãšã‹ã—ã„";
    }

    // Firestore ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã«ä½¿ãˆã‚‹å®‰å…¨ãªã‚­ãƒ¼ã«å¤‰æ›
    function toSafeKey(s) {
      // "/" ã¯ Firestore ã§åŒºåˆ‡ã‚Šæ‰±ã„ãªã®ã§çµ¶å¯¾ã«é¿ã‘ã‚‹
      return String(s)
        .normalize("NFKC")
        .replace(/\s+/g, "_")
        .replace(/[\/\\?%*:|"<>]/g, "_")
        .replace(/[^0-9A-Za-zã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥_ï¼ˆï¼‰()ãƒ»ã€ã€‚-]/g, "_")
        .slice(0, 120);
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚­ãƒ¼ï¼ˆJSTæƒ³å®šã€‚GitHub Pagesã®è¡¨ç¤ºã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç«¯æœ«æ™‚åˆ»ï¼‰
    function todayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    // æ—¥ä»˜ã‹ã‚‰å®‰å®šã—ãŸæ“¬ä¼¼ä¹±æ•°ï¼ˆãƒ†ãƒ¼ãƒå›ºå®šç”¨ï¼‰
    function hashString(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }

    // ===== Data =====
    let items = [];              // {genre,category,theme,text,length,difficulty}
    let categories = [];
    let themes = [];
    let target = "";
    let startTime = 0;
    let ended = false;

    // UI elements
    let selDifficulty, selCategory, selTheme, chkDailyTheme, selRankScope, rankLabel;

    // ç¾åœ¨ã®ã€Œæ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒã€
    let dailyTheme = null;

    async function loadItems() {
      const res = await fetch("./data/trivia.json", { cache: "no-store" });
      const json = await res.json();

      items = json
        .filter(x => x && typeof x.text === "string")
        .map(x => {
          const len = (typeof x.length === "number") ? x.length : x.text.length;
          return {
            genre: x.genre ?? "",
            category: x.category ?? "",
            theme: x.theme ?? "",
            text: x.text,
            length: len,
            difficulty: calcDifficulty(len)
          };
        });

      // category/theme ã®ä¸€è¦§ã‚’ä½œã‚‹ï¼ˆç©ºã¯é™¤å¤–ï¼‰
      const catSet = new Set(items.map(x => x.category).filter(Boolean));
      const themeSet = new Set(items.map(x => x.theme).filter(Boolean));
      categories = Array.from(catSet).sort((a,b) => a.localeCompare(b, "ja"));
      themes = Array.from(themeSet).sort((a,b) => a.localeCompare(b, "ja"));

      // ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã‚’æ±ºå®šï¼ˆthemes ãŒã‚ã‚‹å‰æï¼‰
      if (themes.length > 0) {
        const idx = hashString(todayKey()) % themes.length;
        dailyTheme = themes[idx];
      } else {
        dailyTheme = null;
      }

      // UI ã«é¸æŠè‚¢ã‚’æµã—è¾¼ã‚€
      hydrateSelects();
      updateDailyThemeUI();
      updateCurrentModeBadges();
    }

    function hydrateSelects() {
      // difficulty
      selDifficulty.innerHTML = `
        <option value="all">é›£æ˜“åº¦ï¼šã™ã¹ã¦</option>
        <option value="ã‹ã‚“ãŸã‚“">é›£æ˜“åº¦ï¼šã‹ã‚“ãŸã‚“ï¼ˆã€œ${EASY_MAX}æ–‡å­—ï¼‰</option>
        <option value="ãµã¤ã†">é›£æ˜“åº¦ï¼šãµã¤ã†ï¼ˆ${EASY_MAX+1}ã€œ${NORMAL_MAX}æ–‡å­—ï¼‰</option>
        <option value="ã‚€ãšã‹ã—ã„">é›£æ˜“åº¦ï¼šã‚€ãšã‹ã—ã„ï¼ˆ${NORMAL_MAX+1}æ–‡å­—ã€œï¼‰</option>
      `;

      // category
      selCategory.innerHTML = `<option value="all">ã‚«ãƒ†ã‚´ãƒªï¼šã™ã¹ã¦</option>` +
        categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

      // theme
      selTheme.innerHTML = `<option value="all">ãƒ†ãƒ¼ãƒï¼šã™ã¹ã¦</option>` +
        themes.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      // ranking scope
      selRankScope.innerHTML = `
        <option value="overall">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šå…¨ä½“</option>
        <option value="category">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªï¼‰</option>
        <option value="theme">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šãƒ†ãƒ¼ãƒåˆ¥ï¼ˆç¾åœ¨ã®ãƒ†ãƒ¼ãƒï¼‰</option>
        <option value="daily">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ</option>
      `;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function getActiveFilters() {
      const daily = chkDailyTheme.checked && !!dailyTheme;

      const difficulty = selDifficulty.value;
      const category = daily ? "all" : selCategory.value;
      const theme = daily ? dailyTheme : selTheme.value;

      return { daily, difficulty, category, theme };
    }

    function filterPool() {
      const { daily, difficulty, category, theme } = getActiveFilters();

      return items.filter(x => {
        if (difficulty !== "all" && x.difficulty !== difficulty) return false;
        if (!daily && category !== "all" && x.category !== category) return false;
        if (theme !== "all" && x.theme !== theme) return false;
        return true;
      });
    }

    // é€£ç¶šåŒä¸€å•é¡Œã®å›é¿ï¼ˆè»½ã„å¯¾ç­–ï¼‰
    let lastText = "";

    function setNewText() {
      const pool = filterPool();
      const textEl = document.getElementById("text");

      if (pool.length === 0) {
        target = "";
        textEl.textContent = "è©²å½“ã™ã‚‹æ–‡ç« ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚";
        const input = document.getElementById("input");
        input.value = "";
        input.disabled = true;
        document.getElementById("result").textContent = "";
        document.getElementById("submitBtn").disabled = true;
        updateCurrentModeBadges();
        return;
      }

      // ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆã§ãã‚Œã°å‰å›ã¨é•ã†ã‚‚ã®ï¼‰
      let pick;
      for (let i = 0; i < 6; i++) {
        const cand = pool[Math.floor(Math.random() * pool.length)];
        if (cand.text !== lastText || pool.length === 1) { pick = cand; break; }
      }
      if (!pick) pick = pool[Math.floor(Math.random() * pool.length)];

      lastText = pick.text;
      target = pick.text;

      textEl.textContent = target;

      const input = document.getElementById("input");
      input.value = "";
      input.disabled = false;
      input.focus();

      ended = false;
      startTime = 0;
      document.getElementById("result").textContent = "";
      document.getElementById("submitBtn").disabled = true;

      updateCurrentModeBadges(pick);
      loadRanking(); // æ¡ä»¶ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§éƒ½åº¦æ›´æ–°
    }

    function updateDailyThemeUI() {
      const daily = chkDailyTheme.checked;

      selCategory.disabled = daily;
      selTheme.disabled = daily;

      const dailyInfo = document.getElementById("dailyInfo");
      if (daily && dailyTheme) {
        dailyInfo.textContent = `ä»Šæ—¥ï¼ˆ${todayKey()}ï¼‰ã®ãƒ†ãƒ¼ãƒï¼š${dailyTheme}`;
        dailyInfo.style.display = "block";
      } else {
        dailyInfo.textContent = "";
        dailyInfo.style.display = "none";
      }
    }

    function updateCurrentModeBadges(pickItem = null) {
      const box = document.getElementById("modeBadges");
      const { daily, difficulty, category, theme } = getActiveFilters();
      const poolCount = filterPool().length;

      const badges = [];
      badges.push(`å•é¡Œæ•°ï¼š${poolCount}`);
      badges.push(daily ? `æ—¥æ›¿ã‚ã‚Šï¼šONï¼ˆ${dailyTheme ?? "â€”"}ï¼‰` : "æ—¥æ›¿ã‚ã‚Šï¼šOFF");
      badges.push(`é›£æ˜“åº¦ï¼š${difficulty === "all" ? "ã™ã¹ã¦" : difficulty}`);
      badges.push(`ã‚«ãƒ†ã‚´ãƒªï¼š${daily ? "â€”" : (category === "all" ? "ã™ã¹ã¦" : category)}`);
      badges.push(`ãƒ†ãƒ¼ãƒï¼š${theme === "all" ? "ã™ã¹ã¦" : theme}`);

      if (pickItem) {
        badges.push(`å‡ºé¡Œã®é›£æ˜“åº¦ï¼š${pickItem.difficulty}`);
        badges.push(`æ–‡å­—æ•°ï¼š${pickItem.length}`);
      }

      box.innerHTML = badges.map(b => `<span class="pill">${escapeHtml(b)}</span>`).join("");
      updateRankingLabel();
    }

    // ===== Ranking (åˆ†å²ï¼šã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’ã‚­ãƒ¼ã§åˆ‡ã‚Šæ›¿ãˆã‚‹) =====
    function getRankingKey() {
      const { daily, difficulty, category, theme } = getActiveFilters();
      const scope = selRankScope.value;

      // é›£æ˜“åº¦ã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚­ãƒ¼ã«å«ã‚ã‚‹ï¼ˆã€Œé›£æ˜“åº¦åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ã‚’è‡ªç„¶ã«å®Ÿç¾ï¼‰
      const diffKey = (difficulty === "all") ? "diff_all" : `diff_${difficulty}`;

      if (scope === "overall") {
        return `rk_overall__${diffKey}`;
      }
      if (scope === "daily") {
        const t = dailyTheme ?? "no_theme";
        return `rk_daily__${toSafeKey(t)}__${diffKey}`;
      }
      if (scope === "category") {
        // æ—¥æ›¿ã‚ã‚ŠONæ™‚ã¯ã‚«ãƒ†ã‚´ãƒªãŒå›ºå®šã•ã‚Œãªã„ãŸã‚ã€ã‚«ãƒ†ã‚´ãƒªåˆ¥ã¯ã€Œç„¡åŠ¹ã€æ‰±ã„ã«ã›ãšã€ãƒ†ãƒ¼ãƒã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’æ¨æ¸¬ã—ãªã„
        // ã“ã“ã§ã¯ã€Œé¸æŠä¸­ã®ã‚«ãƒ†ã‚´ãƒªã€ã‚’ä½¿ã†ï¼ˆONã®ã¨ãã¯ all æ‰±ã„ï¼‰
        const c = daily ? "all" : category;
        if (c === "all") return `rk_category__all__${diffKey}`;
        return `rk_category__${toSafeKey(c)}__${diffKey}`;
      }
      if (scope === "theme") {
        const t = (theme === "all") ? "all" : theme;
        return `rk_theme__${toSafeKey(t)}__${diffKey}`;
      }
      return `rk_overall__${diffKey}`;
    }

    function getRankingCollectionName() {
      // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çˆ†ç™ºã‚’æŠ‘ãˆã¤ã¤ã€è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ã«ã™ã‚‹ãŸã‚ã€Œã‚­ãƒ¼ã”ã¨ã«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åˆ†ã‘ã€
      // â€» 1ã‚­ãƒ¼ = 1ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      const key = getRankingKey();
      return `scores__${toSafeKey(key)}`;
    }

    function updateRankingLabel() {
      const scope = selRankScope.value;
      const { daily, difficulty, category, theme } = getActiveFilters();

      const diffText = (difficulty === "all") ? "ï¼ˆé›£æ˜“åº¦ï¼šã™ã¹ã¦ï¼‰" : `ï¼ˆé›£æ˜“åº¦ï¼š${difficulty}ï¼‰`;

      let label = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°";
      if (scope === "overall") label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šå…¨ä½“ ${diffText}`;
      if (scope === "daily") label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã€Œ${dailyTheme ?? "â€”"}ã€ ${diffText}`;
      if (scope === "category") {
        const c = daily ? "â€”" : (category === "all" ? "ã™ã¹ã¦" : category);
        label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šã‚«ãƒ†ã‚´ãƒªã€Œ${c}ã€ ${diffText}`;
      }
      if (scope === "theme") {
        const t = (theme === "all") ? "ã™ã¹ã¦" : theme;
        label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šãƒ†ãƒ¼ãƒã€Œ${t}ã€ ${diffText}`;
      }

      rankLabel.textContent = label;
    }

    async function loadRanking() {
      const list = document.getElementById("ranking");
      list.innerHTML = "";

      const colName = getRankingCollectionName();
      try {
        const q = query(collection(db, colName), orderBy("wpm", "desc"), limit(10));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          const li = document.createElement("li");
          li.textContent = "ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚";
          list.appendChild(li);
          return;
        }
        snapshot.forEach(doc => {
          const d = doc.data();
          const li = document.createElement("li");
          li.textContent = `${d.name} - ${d.wpm} WPM`;
          list.appendChild(li);
        });
      } catch (e) {
        const li = document.createElement("li");
        li.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        list.appendChild(li);
      }
    }

    // ===== Main =====
    window.addEventListener("DOMContentLoaded", async () => {
      // UI hooks
      selDifficulty = document.getElementById("difficulty");
      selCategory = document.getElementById("category");
      selTheme = document.getElementById("theme");
      chkDailyTheme = document.getElementById("dailyTheme");
      selRankScope = document.getElementById("rankScope");
      rankLabel = document.getElementById("rankLabel");

      // Controls events
      selDifficulty.addEventListener("change", () => setNewText());
      selCategory.addEventListener("change", () => setNewText());
      selTheme.addEventListener("change", () => setNewText());
      chkDailyTheme.addEventListener("change", () => { updateDailyThemeUI(); setNewText(); });
      selRankScope.addEventListener("change", () => { updateRankingLabel(); loadRanking(); });

      // Load data
      try {
        await loadItems();
      } catch (e) {
        document.getElementById("text").textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚data/trivia.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        document.getElementById("input").disabled = true;
        return;
      }

      // Typing events
      const inputBox = document.getElementById("input");
      const submitBtn = document.getElementById("submitBtn");

      inputBox.addEventListener("input", () => {
        const input = inputBox.value;
        if (input === target && !ended) {
          ended = true;
          const seconds = (Date.now() - startTime) / 1000;
          const wpm = Math.round((input.length / 5) / (seconds / 60));
          document.getElementById("result").textContent = `å®Œäº†ï¼WPM: ${wpm}`;
          submitBtn.disabled = false;
          submitBtn.dataset.wpm = String(wpm);
        } else if (input.length === 1 && startTime === 0 && target) {
          startTime = Date.now();
        }
      });

      submitBtn.addEventListener("click", async () => {
        const name = document.getElementById("name").value.trim();
        const wpm = parseInt(submitBtn.dataset.wpm, 10);
        if (!name || Number.isNaN(wpm)) {
          alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        // ã©ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ä¿å­˜ã™ã‚‹ã‹ï¼ˆè£ã§åˆ†å²ï¼‰
        const colName = getRankingCollectionName();

        try {
          await addDoc(collection(db, colName), {
            name,
            wpm,
            timestamp: serverTimestamp()
          });
          loadRanking();
          setNewText();
        } catch (e) {
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreè¨­å®šã‚„æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      });

      // First render
      setNewText();
    });
  </script>
</head>

<body>
  <header>
    <h1>æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</h1>
    <p class="lead">
      é›‘å­¦ãƒ»è±†çŸ¥è­˜ã‚’é¡Œæã«ã—ãŸæ–‡ç« ã§ã€æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨çš„ãªæ—¥æœ¬èªå…¥åŠ›ã‚’ç·´ç¿’ã§ãã¾ã™ã€‚
      length ã«ã‚ˆã‚‹é›£æ˜“åº¦åˆ†ã‘ã€æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒã€ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
    </p>
    <p><a class="cta" href="#play">ä»Šã™ãç·´ç¿’ã™ã‚‹</a></p>
  </header>

  <main>
    <section id="play" class="card" aria-label="ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’">
      <h2>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</h2>

      <div class="row" style="margin-bottom:10px;">
        <select id="difficulty" aria-label="é›£æ˜“åº¦"></select>
        <select id="category" aria-label="ã‚«ãƒ†ã‚´ãƒª"></select>
        <select id="theme" aria-label="ãƒ†ãƒ¼ãƒ"></select>
        <label class="checkbox" title="ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã«å›ºå®šã—ã¾ã™ï¼ˆæ¯æ—¥å¤‰ã‚ã‚Šã¾ã™ï¼‰">
          <input type="checkbox" id="dailyTheme" />
          æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒ
        </label>
      </div>

      <p id="dailyInfo" class="muted" style="display:none; margin: 0 0 10px;"></p>
      <div id="modeBadges" style="margin: 0 0 10px;"></div>

      <p id="text">èª­ã¿è¾¼ã¿ä¸­...</p>
      <input type="text" id="input" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°" disabled />
      <div id="result"></div>

      <h3>ã‚¹ã‚³ã‚¢é€ä¿¡ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ï¼‰</h3>
      <div class="row">
        <input type="text" id="name" placeholder="ã‚ãªãŸã®åå‰" />
        <button id="submitBtn" disabled>ã‚¹ã‚³ã‚¢é€ä¿¡</button>
      </div>

      <div class="row" style="margin-top: 16px;">
        <select id="rankScope" aria-label="ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¯„å›²"></select>
        <div id="rankLabel" class="muted"></div>
      </div>

      <h2 style="margin-top:12px;">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h2>
      <ul id="ranking"></ul>

      <noscript>
        <p class="muted">ã“ã®ã‚²ãƒ¼ãƒ ã¯JavaScriptãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
      </noscript>
    </section>

    <section>
      <h2>ç‰¹å¾´</h2>
      <div class="grid">
        <div class="card"><strong>ç„¡æ–™ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦</strong><br>ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§ç·´ç¿’ã§ãã¾ã™ã€‚</div>
        <div class="card"><strong>æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨ç·´ç¿’</strong><br>å®Ÿå‹™ã«è¿‘ã„æ—¥æœ¬èªå…¥åŠ›ã‚’æƒ³å®šã€‚</div>
        <div class="card"><strong>é›£æ˜“åº¦åˆ†ã‘ï¼ˆlengthï¼‰</strong><br>æ–‡ç« ã®é•·ã•ã§æ®µéšçš„ã«ç·´ç¿’ã§ãã¾ã™ã€‚</div>
        <div class="card"><strong>æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒ</strong><br>æ¯æ—¥ãƒ†ãƒ¼ãƒãŒå¤‰ã‚ã‚Šã€é£½ãã«ãã„è¨­è¨ˆã§ã™ã€‚</div>
        <div class="card"><strong>ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</strong><br>è£ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’åˆ†å²ã—ã€æˆé•·ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚</div>
        <div class="card"><strong>é›‘å­¦ãƒ»è±†çŸ¥è­˜ã§ä¸€çŸ³äºŒé³¥</strong><br>å…¥åŠ›ã—ãªãŒã‚‰è‡ªç„¶ã«çŸ¥è­˜ã‚‚å¢—ãˆã¾ã™ã€‚</div>
      </div>
    </section>

    <section>
      <h2>éŠã³æ–¹</h2>
      <ol>
        <li>é›£æ˜“åº¦ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ãƒ†ãƒ¼ãƒã‚’é¸ã³ã¾ã™ï¼ˆã¾ãŸã¯æ—¥æ›¿ã‚ã‚Šã‚’ONï¼‰</li>
        <li>è¡¨ç¤ºã•ã‚ŒãŸæ–‡ç« ã‚’ãã®ã¾ã¾å…¥åŠ›ã—ã¾ã™</li>
        <li>æœ€åˆã®1æ–‡å­—ã§è¨ˆæ¸¬é–‹å§‹ã€å…¨æ–‡ä¸€è‡´ã§å®Œäº†ã—ã¾ã™</li>
        <li>WPMã‚’ç¢ºèªã—ã€å¿…è¦ãªã‚‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«é€ä¿¡ã—ã¾ã™</li>
      </ol>
      <p class="muted">ã‚³ãƒ„ï¼šæœ€åˆã¯é€Ÿåº¦ã‚ˆã‚Šæ­£ç¢ºæ€§ã€‚ãƒŸã‚¹ãŒæ¸›ã£ã¦ã‹ã‚‰ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ä¸Šã’ã‚‹ã¨ä¼¸ã³ã‚„ã™ã„ã§ã™ã€‚</p>
    </section>

    <section>
      <h2>ã‚ˆãã‚ã‚‹è³ªå•</h2>
      <details>
        <summary>é›£æ˜“åº¦ã¯ã©ã†æ±ºã¾ã‚Šã¾ã™ã‹ï¼Ÿ</summary>
        <p>JSONã®lengthï¼ˆæ–‡å­—æ•°ï¼‰ã‚’ä½¿ã£ã¦ã€ã‹ã‚“ãŸã‚“ãƒ»ãµã¤ã†ãƒ»ã‚€ãšã‹ã—ã„ã«åˆ†é¡ã—ã¦ã„ã¾ã™ã€‚</p>
      </details>
      <details>
        <summary>æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒã¯ä½•ãŒå¤‰ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</summary>
        <p>ãã®æ—¥ã®ãƒ†ãƒ¼ãƒï¼ˆä¾‹ï¼šæ˜ ç”»ã€ç§‘å­¦ãªã©ï¼‰ã«å›ºå®šã•ã‚Œã€åŒã˜æ—¥ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨åŒã˜ãƒ†ãƒ¼ãƒã«ãªã‚Šã¾ã™ã€‚</p>
      </details>
      <details>
        <summary>ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã©ã†ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</summary>
        <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¯„å›²ï¼ˆå…¨ä½“ï¼ã‚«ãƒ†ã‚´ãƒªï¼ãƒ†ãƒ¼ãƒï¼ä»Šæ—¥ï¼‰ã¨é›£æ˜“åº¦ã«å¿œã˜ã¦ã€Firestoreã®ä¿å­˜å…ˆï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’è£ã§åˆ†å²ã—ã¦ã„ã¾ã™ã€‚</p>
      </details>
      <details>
        <summary>ã‚¹ãƒãƒ›ã§ã‚‚éŠã¹ã¾ã™ã‹ï¼Ÿ</summary>
        <p>é–²è¦§ã¯å¯èƒ½ã§ã™ãŒã€ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã¨ã—ã¦ã¯PCã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
      </details>
    </section>

    <section>
      <h2>æ›´æ–°æƒ…å ±</h2>
      <ul>
        <li>2025-12-XX: åˆå›å…¬é–‹</li>
      </ul>
    </section>
  </main>

  <footer class="muted">
    <p>Â© 2025</p>
  </footer>
</body>
</html>
