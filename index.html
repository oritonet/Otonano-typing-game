<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO -->
  <title>æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ï½œé›‘å­¦ãƒ»è±†çŸ¥è­˜ã§æ—¥æœ¬èªå…¥åŠ›ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œï¼‰</title>
  <meta name="description" content="æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨çš„ãªæ—¥æœ¬èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ãŒã§ãã‚‹ç„¡æ–™ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ•ãƒˆã€‚é›‘å­¦ãƒ»è±†çŸ¥è­˜æ–‡ç« ã§å…¥åŠ›ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»æ­£ç¢ºæ€§ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‰ã‚Œã¾ã™ã€‚é›£æ˜“åº¦åˆ†ã‘ãƒ»æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œã€‚" />
  <link rel="canonical" href="https://espresso-taro.github.io/Otonano-typing-game/" />

  <!-- OGP -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ï½œé›‘å­¦ãƒ»è±†çŸ¥è­˜ã§æ—¥æœ¬èªå…¥åŠ›ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œï¼‰" />
  <meta property="og:description" content="é›‘å­¦ãƒ»è±†çŸ¥è­˜æ–‡ç« ã§æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã€‚é›£æ˜“åº¦ç²¾å¯†åŒ–ãƒ»æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œã€‚" />
  <meta property="og:url" content="https://espresso-taro.github.io/Otonano-typing-game/" />
  <meta name="twitter:card" content="summary" />

  <style>
    :root { --max: 980px; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      margin: 0;
      line-height: 1.85;
      background: #fafafa;
    }
    header, main, footer {
      max-width: var(--max);
      margin: 0 auto;
      padding: 16px;
    }
    header { padding-top: 28px; }
    h1 { font-size: 1.9rem; margin: 0 0 10px; }
    h2 { margin-top: 28px; }
    .lead { font-size: 1.05rem; margin: 0 0 12px; }
    .muted { color: #555; }

    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, label.checkbox, button, input[type="text"] {
      font-size: 0.95rem;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
    }
    button {
      border: 1px solid #222;
      cursor: pointer;
    }
    label.checkbox {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #ccc;
    }

    /* è¦‹æœ¬æ–‡ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‰²åˆ†ã‘ */
    #text {
      font-size: 1.25em;
      background: #f3f3f3;
      padding: 14px;
      border-radius: 10px;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 2.0;
    }
    .ok { color: #0b5ed7; font-weight: 700; }
    .ng { color: #c00000; font-weight: 700; }

    /* å…¥åŠ›æ¬„ï¼šå¤§ããã€è¦‹ã‚„ã™ã */
    #input {
      width: 100%;
      min-height: 160px;
      font-size: 1.25em;
      margin-top: 12px;
      padding: 14px;
      border-radius: 12px;
      border: 2px solid #bbb;
      box-sizing: border-box;
      font-family: ui-monospace, "Noto Sans Mono", Menlo, Monaco, Consolas, monospace;
      line-height: 1.85;
      resize: vertical;
    }

    #result { margin-top: 10px; font-weight: 700; }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      font-size: 0.9rem;
      margin: 0 6px 6px 0;
    }

    ul { padding-left: 1.2em; }
    #ranking li, #dailyRanking li { margin-bottom: 4px; }

    details {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }
    details + details { margin-top: 10px; }
    footer { padding-bottom: 28px; color: #666; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      orderBy, query, serverTimestamp, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyAqDSPE_HkPbi-J-SqPL4Ys-wR4RaA8wKA",
      authDomain: "otonano-typing-game.firebaseapp.com",
      projectId: "otonano-typing-game",
      storageBucket: "otonano-typing-game.appspot.com",
      messagingSenderId: "475283850178",
      appId: "1:475283850178:web:193d28f17be20a232f4c5b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== é›£æ˜“åº¦ï¼ˆç²¾å¯†åŒ–ï¼‰ =====
    // score = length + å¥èª­ç‚¹ä¿‚æ•° + ã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡ä¿‚æ•°
    const PUNCT_WEIGHT = 6;   // å¥èª­ç‚¹1ã¤ã‚ãŸã‚Š
    const KATA_WEIGHT  = 80;  // ã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡(0-1)Ã—80
    const EASY_SCORE_MAX   = 145;
    const NORMAL_SCORE_MAX = 190;

    function punctCount(text) {
      const m = text.match(/[ã€ã€‚,.!ï¼?ï¼Ÿ]/g);
      return m ? m.length : 0;
    }
    function katakanaRatio(text) {
      const total = (text.match(/[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾¥A-Za-z0-9]/g) || []).length;
      if (total === 0) return 0;
      const kata = (text.match(/[ã‚¡-ãƒ¶ãƒ¼]/g) || []).length;
      return kata / total;
    }
    function difficultyByFeatures(len, pCount, kRatio) {
      const score = Math.round(len + (pCount * PUNCT_WEIGHT) + (kRatio * KATA_WEIGHT));
      let diff = "ã‚€ãšã‹ã—ã„";
      if (score <= EASY_SCORE_MAX) diff = "ã‹ã‚“ãŸã‚“";
      else if (score <= NORMAL_SCORE_MAX) diff = "ãµã¤ã†";
      return { diff, score };
    }

    // ===== Utils =====
    function toSafeKey(s) {
      return String(s)
        .normalize("NFKC")
        .replace(/\s+/g, "_")
        .replace(/[\/\\?%*:|"<>]/g, "_")
        .replace(/[^0-9A-Za-zã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥_ï¼ˆï¼‰()ãƒ»ã€ã€‚-]/g, "_")
        .slice(0, 120);
    }
    function todayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function hashString(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ===== Data =====
    let items = []; // {genre,category,theme,text,length,punct,kataRatio,difficulty,score}
    let categories = [];
    let themeByCategory = new Map(); // category -> themes[]
    let allThemes = [];

    // ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒï¼ˆå…¨ãƒ†ãƒ¼ãƒã‹ã‚‰æ—¥ä»˜ãƒãƒƒã‚·ãƒ¥ã§å›ºå®šï¼‰
    let dailyTheme = null;

    // ===== UI refs =====
    let selDifficulty, selCategory, selTheme, chkDailyTheme, selRankScope;
    let rankLabel, dailyRankLabel, dailyInfoEl, badgesEl;
    let inputBox, submitBtn;

    // ===== Typing state =====
    let target = "";
    let startTime = 0;
    let ended = false;
    let keystrokes = 0;

    // ===== ç›´è¿‘10å•ã®å†å‡ºé¡Œå›é¿ =====
    const HISTORY_MAX = 10;
    const recentTexts = []; // text ã‚’ä¿å­˜

    function pushHistory(text) {
      if (!text) return;
      recentTexts.unshift(text);
      if (recentTexts.length > HISTORY_MAX) recentTexts.length = HISTORY_MAX;
    }
    function isRecentlyUsed(text) {
      return recentTexts.includes(text);
    }

    async function loadItems() {
      const res = await fetch("./data/trivia.json", { cache: "no-store" });
      const json = await res.json();

      items = json
        .filter(x => x && typeof x.text === "string")
        .map(x => {
          const len = (typeof x.length === "number") ? x.length : x.text.length;
          const p = punctCount(x.text);
          const kr = katakanaRatio(x.text);
          const { diff, score } = difficultyByFeatures(len, p, kr);
          return {
            genre: x.genre ?? "",
            category: x.category ?? "",
            theme: x.theme ?? "",
            text: x.text,
            length: len,
            punct: p,
            kataRatio: kr,
            difficulty: diff,
            score
          };
        });

      const catSet = new Set(items.map(x => x.category).filter(Boolean));
      categories = Array.from(catSet).sort((a,b) => a.localeCompare(b, "ja"));

      themeByCategory = new Map();
      for (const c of categories) themeByCategory.set(c, new Set());
      for (const it of items) {
        if (!it.category || !it.theme) continue;
        if (!themeByCategory.has(it.category)) themeByCategory.set(it.category, new Set());
        themeByCategory.get(it.category).add(it.theme);
      }

      const themeSet = new Set(items.map(x => x.theme).filter(Boolean));
      allThemes = Array.from(themeSet).sort((a,b) => a.localeCompare(b, "ja"));

      if (allThemes.length > 0) {
        const idx = hashString(todayKey()) % allThemes.length;
        dailyTheme = allThemes[idx];
      } else {
        dailyTheme = null;
      }

      hydrateSelects();
      applyThemeOptionsByCategory();
      updateDailyThemeUI();
      updateBadges(null);

      // åˆæœŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå›ºå®šTOP + é€šå¸¸ï¼‰
      await loadDailyRanking();
      await loadRanking();
    }

    function hydrateSelects() {
      selDifficulty.innerHTML = `
        <option value="all">é›£æ˜“åº¦ï¼šã™ã¹ã¦</option>
        <option value="ã‹ã‚“ãŸã‚“">é›£æ˜“åº¦ï¼šã‹ã‚“ãŸã‚“</option>
        <option value="ãµã¤ã†">é›£æ˜“åº¦ï¼šãµã¤ã†</option>
        <option value="ã‚€ãšã‹ã—ã„">é›£æ˜“åº¦ï¼šã‚€ãšã‹ã—ã„</option>
      `;

      selCategory.innerHTML =
        `<option value="all">ã‚«ãƒ†ã‚´ãƒªï¼šã™ã¹ã¦</option>` +
        categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

      selTheme.innerHTML = `<option value="all">ãƒ†ãƒ¼ãƒï¼šã™ã¹ã¦</option>`;

      selRankScope.innerHTML = `
        <option value="overall">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šå…¨ä½“</option>
        <option value="category">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªï¼‰</option>
        <option value="theme">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šãƒ†ãƒ¼ãƒåˆ¥ï¼ˆç¾åœ¨ã®ãƒ†ãƒ¼ãƒï¼‰</option>
        <option value="daily">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ</option>
      `;
    }

    // è¦æœ›ï¼šã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ãƒ†ãƒ¼ãƒã ã‘è¡¨ç¤ºï¼ˆã‚«ãƒ†ã‚´ãƒªãŒã€Œã™ã¹ã¦ã€ãªã‚‰å…¨ãƒ†ãƒ¼ãƒï¼‰
    function applyThemeOptionsByCategory() {
      const daily = chkDailyTheme.checked && !!dailyTheme;
      if (daily) return; // æ—¥æ›¿ã‚ã‚Šå›ºå®šä¸­ã¯ theme é¸æŠã¯ disabledï¼ˆå€™è£œæ›´æ–°ä¸è¦ï¼‰

      const cat = selCategory.value;
      const currentTheme = selTheme.value;

      let themes = [];
      if (cat === "all") {
        themes = allThemes;
      } else {
        const set = themeByCategory.get(cat);
        themes = set ? Array.from(set).sort((a,b) => a.localeCompare(b, "ja")) : [];
      }

      selTheme.innerHTML =
        `<option value="all">ãƒ†ãƒ¼ãƒï¼šã™ã¹ã¦</option>` +
        themes.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      selTheme.value = themes.includes(currentTheme) ? currentTheme : "all";
    }

    function getActiveFilters() {
      const daily = chkDailyTheme.checked && !!dailyTheme;

      const difficulty = selDifficulty.value;
      const category = daily ? "all" : selCategory.value;
      const theme = daily ? dailyTheme : selTheme.value;

      return { daily, difficulty, category, theme };
    }

    function filterPool() {
      const { daily, difficulty, category, theme } = getActiveFilters();
      return items.filter(x => {
        if (difficulty !== "all" && x.difficulty !== difficulty) return false;
        if (!daily && category !== "all" && x.category !== category) return false;
        if (theme !== "all" && x.theme !== theme) return false;
        return true;
      });
    }

    function pickNextItem(pool) {
      if (pool.length === 0) return null;

      // ç›´è¿‘10å•ã‚’å›é¿ï¼ˆå€™è£œãŒå°‘ãªã‘ã‚Œã°ä¾‹å¤–çš„ã«è¨±å®¹ï¼‰
      const notRecent = pool.filter(x => !isRecentlyUsed(x.text));
      const candidates = (notRecent.length > 0) ? notRecent : pool;

      return candidates[Math.floor(Math.random() * candidates.length)];
    }

    // ===== è¦‹æœ¬æ–‡ï¼šæ­£è§£é’ï¼èª¤ã‚Šèµ¤ï¼ˆæœ€åˆã®èª¤ã‚Šä»¥é™ã‚’èµ¤ã«å¯„ã›ã‚‹ï¼‰ =====
    function renderTarget(typed) {
      const textEl = document.getElementById("text");
      const t = target ?? "";
      const v = typed ?? "";

      // typed ãŒ target ã‚ˆã‚Šé•·ã„å ´åˆã‚‚ã‚ã‚‹ï¼ˆãã®æ™‚ç‚¹ã§èª¤ã‚Šï¼‰
      const typedLen = v.length;
      const targetLen = t.length;

      let mismatch = -1;
      const minLen = Math.min(typedLen, targetLen);
      for (let i = 0; i < minLen; i++) {
        if (v[i] !== t[i]) { mismatch = i; break; }
      }
      if (mismatch === -1 && typedLen > targetLen) mismatch = targetLen;

      // mismatch === -1 : ã™ã¹ã¦ä¸€è‡´ï¼ˆå…¥åŠ›é€”ä¸­ï¼‰
      // mismatch >= 0 : mismatchä»¥é™ã¯ã€Œèª¤ã‚Šæ‰±ã„ã€
      let html = "";
      if (mismatch === -1) {
        // å…ˆé ­ã‹ã‚‰ typedLen ã¾ã§ã¯æ­£è§£
        const okPart = t.slice(0, typedLen);
        const rest = t.slice(typedLen);
        html =
          `<span class="ok">${escapeHtml(okPart)}</span>` +
          `${escapeHtml(rest)}`;
      } else {
        const okPart = t.slice(0, mismatch);
        const ngPart = t.slice(mismatch, Math.min(typedLen, targetLen));
        const rest = t.slice(Math.min(typedLen, targetLen));
        html =
          `<span class="ok">${escapeHtml(okPart)}</span>` +
          `<span class="ng">${escapeHtml(ngPart)}</span>` +
          `${escapeHtml(rest)}`;
      }
      textEl.innerHTML = html;
    }

    function resetTypingState() {
      startTime = 0;
      ended = false;
      keystrokes = 0;
      submitBtn.disabled = true;
      document.getElementById("result").textContent = "";
    }

    function setNewText({ fromSkip = false } = {}) {
      const pool = filterPool();
      if (pool.length === 0) {
        target = "";
        document.getElementById("text").textContent = "è©²å½“ã™ã‚‹æ–‡ç« ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚";
        inputBox.value = "";
        inputBox.disabled = true;
        resetTypingState();
        updateBadges(null);
        return;
      }

      const pick = pickNextItem(pool);
      target = pick.text;

      // å±¥æ­´ï¼šã‚¹ã‚­ãƒƒãƒ—ãƒ»é€šå¸¸ã©ã¡ã‚‰ã§ã‚‚ã€Œå‡ºé¡Œæ¸ˆã€ã¨ã—ã¦æ‰±ã†ï¼ˆå†å‡ºé¡Œå›é¿ã‚’å¼·ã‚ã‚‹ï¼‰
      pushHistory(target);

      inputBox.disabled = false;
      inputBox.value = "";
      inputBox.focus();

      resetTypingState();
      renderTarget("");

      updateBadges(pick);

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ï¼ˆå›ºå®šTOP + é€šå¸¸ï¼‰
      loadDailyRanking();
      loadRanking();
    }

    function updateDailyThemeUI() {
      const daily = chkDailyTheme.checked && !!dailyTheme;

      selCategory.disabled = daily;
      selTheme.disabled = daily;

      if (dailyTheme) {
        dailyInfoEl.textContent = `ä»Šæ—¥ï¼ˆ${todayKey()}ï¼‰ã®ãƒ†ãƒ¼ãƒï¼š${dailyTheme}` + (daily ? "ï¼ˆå›ºå®šä¸­ï¼‰" : "");
        dailyInfoEl.style.display = "block";
      } else {
        dailyInfoEl.textContent = "";
        dailyInfoEl.style.display = "none";
      }
    }

    function updateBadges(pickItem) {
      const { daily, difficulty, category, theme } = getActiveFilters();
      const badges = [];

      badges.push(daily ? `æ—¥æ›¿ã‚ã‚Šï¼šONï¼ˆ${dailyTheme ?? "â€”"}ï¼‰` : "æ—¥æ›¿ã‚ã‚Šï¼šOFF");
      badges.push(`é›£æ˜“åº¦è¨­å®šï¼š${difficulty === "all" ? "ã™ã¹ã¦" : difficulty}`);
      badges.push(`ã‚«ãƒ†ã‚´ãƒªï¼š${daily ? "â€”" : (category === "all" ? "ã™ã¹ã¦" : category)}`);
      badges.push(`ãƒ†ãƒ¼ãƒï¼š${theme === "all" ? "ã™ã¹ã¦" : theme}`);

      // è¦æœ›ï¼šå•é¡Œæ•°ã¯éè¡¨ç¤ºï¼ˆã“ã“ã§ã¯å‡ºã•ãªã„ï¼‰
      if (pickItem) {
        const kataPct = Math.round(pickItem.kataRatio * 100);
        badges.push(`å‡ºé¡Œé›£æ˜“åº¦ï¼š${pickItem.difficulty}`);
        badges.push(`æ–‡å­—æ•°ï¼š${pickItem.length}`);
        badges.push(`å¥èª­ç‚¹ï¼š${pickItem.punct}`);
        badges.push(`ã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡ï¼š${kataPct}%`);
      }

      badgesEl.innerHTML = badges.map(b => `<span class="pill">${escapeHtml(b)}</span>`).join("");
      updateRankingLabels();
    }

    // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè£åˆ†å²ï¼‰ =====
    function getRankingKey(scope) {
      const { daily, difficulty, category, theme } = getActiveFilters();
      const diffKey = (difficulty === "all") ? "diff_all" : `diff_${difficulty}`;

      if (scope === "overall") return `rk_overall__${diffKey}`;
      if (scope === "daily") {
        const t = dailyTheme ?? "no_theme";
        return `rk_daily__${toSafeKey(t)}__${diffKey}`;
      }
      if (scope === "category") {
        const c = daily ? "all" : category;
        return `rk_category__${toSafeKey(c)}__${diffKey}`;
      }
      if (scope === "theme") {
        const t = (theme === "all") ? "all" : theme;
        return `rk_theme__${toSafeKey(t)}__${diffKey}`;
      }
      return `rk_overall__${diffKey}`;
    }

    function getCollectionNameByScope(scope) {
      return `scores__${toSafeKey(getRankingKey(scope))}`;
    }

    function updateRankingLabels() {
      const { daily, difficulty, category, theme } = getActiveFilters();
      const diffText = (difficulty === "all") ? "ï¼ˆé›£æ˜“åº¦ï¼šã™ã¹ã¦ï¼‰" : `ï¼ˆé›£æ˜“åº¦ï¼š${difficulty}ï¼‰`;

      dailyRankLabel.textContent = `ğŸ† ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã€Œ${dailyTheme ?? "â€”"}ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10 ${diffText}`;

      const scope = selRankScope.value;
      let label = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°";
      if (scope === "overall") label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šå…¨ä½“ TOP10 ${diffText}`;
      if (scope === "daily") label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã€Œ${dailyTheme ?? "â€”"}ã€TOP10 ${diffText}`;
      if (scope === "category") {
        const c = daily ? "â€”" : (category === "all" ? "ã™ã¹ã¦" : category);
        label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šã‚«ãƒ†ã‚´ãƒªã€Œ${c}ã€TOP10 ${diffText}`;
      }
      if (scope === "theme") {
        const t = (theme === "all") ? "ã™ã¹ã¦" : theme;
        label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šãƒ†ãƒ¼ãƒã€Œ${t}ã€TOP10 ${diffText}`;
      }
      rankLabel.textContent = label;
    }

    async function loadDailyRanking() {
      const list = document.getElementById("dailyRanking");
      list.innerHTML = "";

      const colName = getCollectionNameByScope("daily");

      try {
        const q = query(collection(db, colName), orderBy("wpm", "desc"), limit(10));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          const li = document.createElement("li");
          li.textContent = "ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚";
          list.appendChild(li);
          return;
        }

        snapshot.forEach(doc => {
          const d = doc.data();
          const li = document.createElement("li");
          li.textContent = `${d.name} - ${d.wpm} WPM`;
          list.appendChild(li);
        });
      } catch (e) {
        const li = document.createElement("li");
        li.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        list.appendChild(li);
      }
    }

    async function loadRanking() {
      const list = document.getElementById("ranking");
      list.innerHTML = "";

      const scope = selRankScope.value;
      const colName = getCollectionNameByScope(scope);

      try {
        const q = query(collection(db, colName), orderBy("wpm", "desc"), limit(10));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          const li = document.createElement("li");
          li.textContent = "ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚";
          list.appendChild(li);
          return;
        }

        snapshot.forEach(doc => {
          const d = doc.data();
          const li = document.createElement("li");
          li.textContent = `${d.name} - ${d.wpm} WPM`;
          list.appendChild(li);
        });
      } catch (e) {
        const li = document.createElement("li");
        li.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        list.appendChild(li);
      }
    }

    // ===== ã‚¹ã‚³ã‚¢è¨ˆæ¸¬ï¼ˆæ—¥æœ¬èªå‘ã‘ï¼šCPM/KPM + å‚è€ƒWPMï¼‰ =====
    function computeMetrics(typed, seconds, keystrokesCount) {
      const minutes = seconds / 60;
      const cpm = Math.round(typed.length / minutes);
      const kpm = Math.round(keystrokesCount / minutes);
      const wpm = Math.round((typed.length / 5) / minutes); // å‚è€ƒï¼ˆè‹±èªäº’æ›ï¼‰
      return { cpm, kpm, wpm };
    }

    // ===== ä¿å­˜ï¼ˆãŠã™ã™ã‚ï¼šè¤‡æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åŒæ™‚ä¿å­˜ï¼‰ =====
    // UXãŒè‰¯ããªã‚‹ï¼ˆã©ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã¦ã‚‚ç©ºã«ãªã‚Šã«ãã„ï¼‰
    async function saveScoreToMultipleBoards({ name, wpm }) {
      const targets = ["overall", "daily", "category", "theme"].map(scope => {
        const colName = getCollectionNameByScope(scope);
        return addDoc(collection(db, colName), {
          name,
          wpm,
          timestamp: serverTimestamp()
        });
      });
      await Promise.allSettled(targets);
    }

    // ===== Main =====
    window.addEventListener("DOMContentLoaded", async () => {
      selDifficulty = document.getElementById("difficulty");
      selCategory = document.getElementById("category");
      selTheme = document.getElementById("theme");
      chkDailyTheme = document.getElementById("dailyTheme");
      selRankScope = document.getElementById("rankScope");
      rankLabel = document.getElementById("rankLabel");
      dailyRankLabel = document.getElementById("dailyRankLabel");
      dailyInfoEl = document.getElementById("dailyInfo");
      badgesEl = document.getElementById("modeBadges");
      inputBox = document.getElementById("input");
      submitBtn = document.getElementById("submitBtn");

      // Controls
      selDifficulty.addEventListener("change", () => setNewText());
      selCategory.addEventListener("change", () => {
        applyThemeOptionsByCategory();
        setNewText();
      });
      selTheme.addEventListener("change", () => setNewText());

      chkDailyTheme.addEventListener("change", () => {
        updateDailyThemeUI();
        applyThemeOptionsByCategory();
        setNewText();
      });

      selRankScope.addEventListener("change", () => {
        updateRankingLabels();
        loadRanking();
      });

      document.getElementById("skipBtn").addEventListener("click", () => setNewText({ fromSkip: true }));

      // Load data
      try {
        await loadItems();
      } catch (e) {
        document.getElementById("text").textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚data/trivia.json ã®ç½®ãå ´æ‰€ã¨JSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        inputBox.disabled = true;
        return;
      }

      // Typing: keystrokes count
      inputBox.addEventListener("keydown", (e) => {
        // 1æ–‡å­—å…¥åŠ›ã€ã‚¹ãƒšãƒ¼ã‚¹ã€Backspace/Delete ã‚’æ‰“éµã¨ã—ã¦æ•°ãˆã‚‹ï¼ˆIMEä¸­ã‚‚æ¦‚ã­åæ˜ ã•ã‚Œã‚‹ï¼‰
        if (e.key.length === 1 || e.key === "Backspace" || e.key === "Delete") {
          keystrokes++;
        }
      });

      // Typing: live render + finish
      inputBox.addEventListener("input", () => {
        const typed = inputBox.value;

        // è¦‹æœ¬æ–‡æ›´æ–°ï¼ˆæ­£è§£é’ã€èª¤ã‚Šèµ¤ï¼‰
        renderTarget(typed);

        // è¨ˆæ¸¬é–‹å§‹ï¼šæœ€åˆã®1æ–‡å­—ï¼ˆç©ºâ†’1æ–‡å­—ã«ãªã£ãŸç¬é–“ï¼‰
        if (typed.length === 1 && startTime === 0 && target) {
          startTime = Date.now();
          keystrokes = 0; // è¨ˆæ¸¬é–‹å§‹æ™‚ç‚¹ã§ãƒªã‚»ãƒƒãƒˆï¼ˆé–‹å§‹å‰ã«æŠ¼ã—ãŸã‚­ãƒ¼ã‚’é™¤å¤–ï¼‰
        }

        // å®Œäº†åˆ¤å®š
        if (!ended && typed === target) {
          ended = true;
          const seconds = (Date.now() - startTime) / 1000;
          const { cpm, kpm, wpm } = computeMetrics(typed, seconds, keystrokes);

          document.getElementById("result").innerHTML =
            `å®Œäº†ï¼<br>` +
            `<strong>CPMï¼ˆæ–‡å­—/åˆ†ï¼‰:</strong> ${cpm}<br>` +
            `<strong>KPMï¼ˆæ‰“éµ/åˆ†ï¼‰:</strong> ${kpm}<br>` +
            `<strong>å‚è€ƒWPM:</strong> ${wpm}`;

          submitBtn.disabled = false;
          submitBtn.dataset.wpm = String(wpm);
        }
      });

      // Submit
      submitBtn.addEventListener("click", async () => {
        const name = document.getElementById("name").value.trim();
        const wpm = parseInt(submitBtn.dataset.wpm, 10);

        if (!name || Number.isNaN(wpm)) {
          alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        try {
          await saveScoreToMultipleBoards({ name, wpm });
          await loadDailyRanking();
          await loadRanking();
          setNewText();
        } catch (e) {
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreè¨­å®šã‚„æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      });

      // First render
      updateRankingLabels();
      setNewText();
    });
  </script>
</head>

<body>
  <header>
    <h1>æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</h1>
    <p class="lead">
      é›‘å­¦ãƒ»è±†çŸ¥è­˜ã®æ–‡ç« ã§ã€æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨çš„ãªæ—¥æœ¬èªå…¥åŠ›ã‚’ç·´ç¿’ã§ãã¾ã™ã€‚
      é›£æ˜“åº¦ã¯ length ã«åŠ ãˆã¦ã€Œå¥èª­ç‚¹æ•°ã€ã€Œã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡ã€ã‚‚è€ƒæ…®ã—ã¦ç²¾å¯†åŒ–ã—ã¦ã„ã¾ã™ã€‚
    </p>
    <p class="muted">æ­£è§£ã—ã¦ã„ã‚‹éƒ¨åˆ†ã¯é’ã€é–“é•ã„å§‹ã‚ãŸç®‡æ‰€ã‹ã‚‰èµ¤ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
  </header>

  <main>
    <section id="play" class="card" aria-label="ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’">
      <h2>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</h2>

      <div class="row" style="margin-bottom:10px;">
        <select id="difficulty" aria-label="é›£æ˜“åº¦"></select>
        <select id="category" aria-label="ã‚«ãƒ†ã‚´ãƒª"></select>
        <select id="theme" aria-label="ãƒ†ãƒ¼ãƒ"></select>
        <label class="checkbox" title="ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã«å›ºå®šã—ã¾ã™ï¼ˆæ¯æ—¥å¤‰ã‚ã‚Šã¾ã™ï¼‰">
          <input type="checkbox" id="dailyTheme" />
          æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒ
        </label>
      </div>

      <p id="dailyInfo" class="muted" style="display:none; margin: 0 0 10px;"></p>
      <div id="modeBadges" style="margin: 0 0 10px;"></div>

      <p id="text">èª­ã¿è¾¼ã¿ä¸­...</p>

      <textarea id="input" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°" disabled></textarea>

      <div class="row" style="margin-top: 10px;">
        <button id="skipBtn" type="button">åˆ¥ã®æ–‡ç« ã«ã™ã‚‹</button>
      </div>

      <div id="result"></div>

      <h3 style="margin-top:16px;">ã‚¹ã‚³ã‚¢é€ä¿¡ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ï¼‰</h3>
      <div class="row">
        <input type="text" id="name" placeholder="ã‚ãªãŸã®åå‰" />
        <button id="submitBtn" disabled>ã‚¹ã‚³ã‚¢é€ä¿¡</button>
      </div>

      <!-- å›ºå®šTOPï¼šä»Šæ—¥ã®ãƒ†ãƒ¼ãƒãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
      <h2 style="margin-top: 22px;">ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <div class="muted" id="dailyRankLabel" style="margin-bottom: 8px;"></div>
      <ul id="dailyRanking"></ul>

      <!-- é€šå¸¸ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
      <h2 style="margin-top: 22px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <div class="row" style="margin-top: 0;">
        <select id="rankScope" aria-label="ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¯„å›²"></select>
        <div id="rankLabel" class="muted"></div>
      </div>
      <ul id="ranking" style="margin-top: 10px;"></ul>

      <noscript>
        <p class="muted">ã“ã®ã‚²ãƒ¼ãƒ ã¯JavaScriptãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
      </noscript>
    </section>

    <section style="margin-top: 16px;">
      <h2>ã‚ˆãã‚ã‚‹è³ªå•</h2>
      <details>
        <summary>åŒã˜æ–‡ç« ãŒä½•åº¦ã‚‚å‡ºã¾ã›ã‚“ã‹ï¼Ÿ</summary>
        <p>ç›´è¿‘10å•ã¯å†å‡ºé¡Œã•ã‚Œã«ãã„ã‚ˆã†ã«åˆ¶å¾¡ã—ã¦ã„ã¾ã™ï¼ˆå€™è£œãŒå°‘ãªã„å ´åˆã¯ä¾‹å¤–ï¼‰ã€‚</p>
      </details>
      <details>
        <summary>é›£æ˜“åº¦ã¯ã©ã†æ±ºã¾ã‚Šã¾ã™ã‹ï¼Ÿ</summary>
        <p>lengthï¼ˆæ–‡å­—æ•°ï¼‰ã«åŠ ãˆã¦ã€å¥èª­ç‚¹ã®æ•°ã¨ã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡ã‚‚åŠ å‘³ã—ã¦åˆ¤å®šã—ã¾ã™ã€‚</p>
      </details>
      <details>
        <summary>ãƒ†ãƒ¼ãƒã®å€™è£œãŒå°‘ãªã„ã®ã¯ãªãœï¼Ÿ</summary>
        <p>é¸ã‚“ã ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ãƒ†ãƒ¼ãƒã ã‘ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã§ã™ï¼ˆã‚«ãƒ†ã‚´ãƒªã‚’ã€Œã™ã¹ã¦ã€ã«ã™ã‚‹ã¨å…¨ãƒ†ãƒ¼ãƒãŒå‡ºã¾ã™ï¼‰ã€‚</p>
      </details>
      <details>
        <summary>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã©ã†ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</summary>
        <p>å…¨ä½“ï¼ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒï¼ã‚«ãƒ†ã‚´ãƒªï¼ãƒ†ãƒ¼ãƒã®å„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã€è£ã§åˆ†å²ã—ã¦ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚</p>
      </details>
    </section>
  </main>

  <footer>
    <p>Â© 2025</p>
  </footer>
</body>
</html>
