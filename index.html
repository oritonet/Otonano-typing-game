<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO -->
  <title>æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ï½œé›‘å­¦ãƒ»è±†çŸ¥è­˜ã§æ—¥æœ¬èªå…¥åŠ›ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œï¼‰</title>
  <meta name="description" content="æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨çš„ãªæ—¥æœ¬èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ãŒã§ãã‚‹ç„¡æ–™ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ•ãƒˆã€‚é›‘å­¦ãƒ»è±†çŸ¥è­˜æ–‡ç« ã§å…¥åŠ›ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»æ­£ç¢ºæ€§ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‰ã‚Œã¾ã™ã€‚é›£æ˜“åº¦ç²¾å¯†åŒ–ãƒ»æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»å€‹äººå±¥æ­´ãƒ»åˆ†æï¼ˆCPM/KPM/ãƒ©ãƒ³ã‚¯/æ¨ç§»ï¼‰å¯¾å¿œã€‚" />
  <link rel="canonical" href="https://espresso-taro.github.io/Otonano-typing-game/" />

  <!-- OGP -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ï½œé›‘å­¦ãƒ»è±†çŸ¥è­˜ã§æ—¥æœ¬èªå…¥åŠ›ã¨çŸ¥è­˜ã‚’åŒæ™‚ã«é›ãˆã‚‹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œï¼‰" />
  <meta property="og:description" content="é›‘å­¦ãƒ»è±†çŸ¥è­˜æ–‡ç« ã§æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ã€‚é›£æ˜“åº¦ç²¾å¯†åŒ–ãƒ»æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»å€‹äººå±¥æ­´ãƒ»åˆ†æå¯¾å¿œã€‚" />
  <meta property="og:url" content="https://espresso-taro.github.io/Otonano-typing-game/" />
  <meta name="twitter:card" content="summary" />

  <style>
    :root { --max: 980px; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      margin: 0;
      line-height: 1.85;
      background: #fafafa;
    }
    header, main, footer {
      max-width: var(--max);
      margin: 0 auto;
      padding: 16px;
    }
    header { padding-top: 28px; }
    h1 { font-size: 1.9rem; margin: 0 0 10px; }
    h2 { margin-top: 26px; }
    h3 { margin-top: 18px; }
    .lead { font-size: 1.05rem; margin: 0 0 12px; }
    .muted { color: #555; }

    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, label.checkbox, button, input[type="text"] {
      font-size: 0.95rem;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
    }
    button { border: 1px solid #222; cursor: pointer; }
    button[disabled] { opacity: 0.55; cursor: not-allowed; }
    label.checkbox {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #ccc;
    }

    /* è¦‹æœ¬æ–‡ï¼šæ­£è§£é’ï¼èª¤ã‚Šèµ¤ */
    #text {
      font-size: 1.25em;
      background: #f3f3f3;
      padding: 14px;
      border-radius: 10px;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 2.0;
      margin: 10px 0 0;
    }
    .ok { color: #0b5ed7; font-weight: 700; }
    .ng { color: #c00000; font-weight: 700; }

    /* å…¥åŠ›æ¬„ï¼šå¤§ããã€è¦‹ã‚„ã™ã */
    #input {
      width: 100%;
      min-height: 170px;
      font-size: 1.25em;
      margin-top: 12px;
      padding: 14px;
      border-radius: 12px;
      border: 2px solid #bbb;
      box-sizing: border-box;
      font-family: ui-monospace, "Noto Sans Mono", Menlo, Monaco, Consolas, monospace;
      line-height: 1.85;
      resize: vertical;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      font-size: 0.9rem;
      margin: 0 6px 6px 0;
    }

    #result { margin-top: 10px; font-weight: 700; }
    ul { padding-left: 1.2em; }
    #ranking li, #dailyRanking li, #myRecent li { margin-bottom: 4px; }

    details {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }
    details + details { margin-top: 10px; }

    .split {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px) {
      .split { grid-template-columns: 1fr 1fr; }
    }
    canvas { width: 100%; height: 220px; border: 1px solid #eee; border-radius: 10px; background: #fff; }

    footer { padding-bottom: 28px; color: #666; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, setDoc, doc,
      orderBy, query, serverTimestamp, limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // =========================
    // Firebase
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyAqDSPE_HkPbi-J-SqPL4Ys-wR4RaA8wKA",
      authDomain: "otonano-typing-game.firebaseapp.com",
      projectId: "otonano-typing-game",
      storageBucket: "otonano-typing-game.appspot.com",
      messagingSenderId: "475283850178",
      appId: "1:475283850178:web:193d28f17be20a232f4c5b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ï¼ˆï¼ç™»éŒ²ã®æœ€å°å½¢ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ„è­˜ã›ãšå±¥æ­´ãŒæŒã¦ã‚‹ï¼‰
    signInAnonymously(auth).catch(() => { /* noop */ });

    // =========================
    // é›£æ˜“åº¦ï¼ˆç²¾å¯†åŒ–ï¼‰
    // score = length + å¥èª­ç‚¹ä¿‚æ•° + ã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡ä¿‚æ•°
    // =========================
    const PUNCT_WEIGHT = 6;
    const KATA_WEIGHT  = 80;
    const EASY_SCORE_MAX   = 145;
    const NORMAL_SCORE_MAX = 190;

    function punctCount(text) {
      const m = text.match(/[ã€ã€‚,.!ï¼?ï¼Ÿ]/g);
      return m ? m.length : 0;
    }
    function katakanaRatio(text) {
      const total = (text.match(/[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾¥A-Za-z0-9]/g) || []).length;
      if (total === 0) return 0;
      const kata = (text.match(/[ã‚¡-ãƒ¶ãƒ¼]/g) || []).length;
      return kata / total;
    }
    function difficultyByFeatures(len, pCount, kRatio) {
      const score = Math.round(len + (pCount * PUNCT_WEIGHT) + (kRatio * KATA_WEIGHT));
      let diff = "ã‚€ãšã‹ã—ã„";
      if (score <= EASY_SCORE_MAX) diff = "ã‹ã‚“ãŸã‚“";
      else if (score <= NORMAL_SCORE_MAX) diff = "ãµã¤ã†";
      return { diff, score };
    }

    // =========================
    // ãƒ©ãƒ³ã‚¯ï¼ˆSSSã€œDï¼‰ï¼šCPM & KPMã‹ã‚‰åˆ¤å®š
    // =========================
    function calcRank(cpm, kpm) {
      const eff = (kpm > 0) ? (cpm / kpm) : 0;
      if (cpm >= 420 && eff >= 0.92) return "SSS";
      if (cpm >= 360 && eff >= 0.88) return "SS";
      if (cpm >= 320 && eff >= 0.84) return "S";
      if (cpm >= 260 && eff >= 0.78) return "A";
      if (cpm >= 200 && eff >= 0.72) return "B";
      if (cpm >= 150) return "C";
      return "D";
    }
    const RANK_SCORE = { "D":1, "C":2, "B":3, "A":4, "S":5, "SS":6, "SSS":7 };
    function betterRank(a, b) {
      return (RANK_SCORE[a] ?? 0) >= (RANK_SCORE[b] ?? 0) ? a : b;
    }

    // =========================
    // Utils
    // =========================
    function toSafeKey(s) {
      return String(s)
        .normalize("NFKC")
        .replace(/\s+/g, "_")
        .replace(/[\/\\?%*:|"<>]/g, "_")
        .replace(/[^0-9A-Za-zã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥_ï¼ˆï¼‰()ãƒ»ã€ã€‚-]/g, "_")
        .slice(0, 120);
    }
    function todayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function hashString(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    // =========================
    // Data
    // =========================
    let items = []; // {genre,category,theme,text,length,punct,kataRatio,difficulty,score}
    let categories = [];
    let themeByCategory = new Map();
    let allThemes = [];
    let dailyTheme = null;

    // =========================
    // UI refs
    // =========================
    let selDifficulty, selCategory, selTheme, chkDailyTheme, selRankScope;
    let rankLabel, dailyRankLabel, dailyInfoEl, badgesEl;
    let inputBox, submitBtn, skipBtn;
    let userBadgeEl;

    // =========================
    // Typing state
    // =========================
    let target = "";
    let startTime = 0;
    let ended = false;

    // KPMï¼ˆIMEå¯„ã‚Šå¼·åŒ–ï¼‰ï¼šæ–‡å­—/Backspace/Delete/Space(å¤‰æ›)/Enter(ç¢ºå®š) ã‚’å…¨éƒ¨ã‚«ã‚¦ãƒ³ãƒˆ
    let keystrokes = 0;

    // ç›´è¿‘10å•ã®å†å‡ºé¡Œå›é¿
    const HISTORY_MAX = 10;
    const recentTexts = [];
    function pushHistory(text) {
      if (!text) return;
      recentTexts.unshift(text);
      if (recentTexts.length > HISTORY_MAX) recentTexts.length = HISTORY_MAX;
    }
    function isRecentlyUsed(text) {
      return recentTexts.includes(text);
    }

    // =========================
    // Load trivia.json
    // =========================
    async function loadItems() {
      const res = await fetch("./data/trivia.json", { cache: "no-store" });
      const json = await res.json();

      items = json
        .filter(x => x && typeof x.text === "string")
        .map(x => {
          const len = (typeof x.length === "number") ? x.length : x.text.length;
          const p = punctCount(x.text);
          const kr = katakanaRatio(x.text);
          const { diff, score } = difficultyByFeatures(len, p, kr);
          return {
            genre: x.genre ?? "",
            category: x.category ?? "",
            theme: x.theme ?? "",
            text: x.text,
            length: len,
            punct: p,
            kataRatio: kr,
            difficulty: diff,
            score
          };
        });

      const catSet = new Set(items.map(x => x.category).filter(Boolean));
      categories = Array.from(catSet).sort((a,b) => a.localeCompare(b, "ja"));

      themeByCategory = new Map();
      for (const c of categories) themeByCategory.set(c, new Set());
      for (const it of items) {
        if (!it.category || !it.theme) continue;
        if (!themeByCategory.has(it.category)) themeByCategory.set(it.category, new Set());
        themeByCategory.get(it.category).add(it.theme);
      }

      const themeSet = new Set(items.map(x => x.theme).filter(Boolean));
      allThemes = Array.from(themeSet).sort((a,b) => a.localeCompare(b, "ja"));

      if (allThemes.length > 0) {
        const idx = hashString(todayKey()) % allThemes.length;
        dailyTheme = allThemes[idx];
      } else {
        dailyTheme = null;
      }

      hydrateSelects();
      applyThemeOptionsByCategory();
      updateDailyThemeUI();
      updateBadges(null);

      await loadDailyRanking();
      await loadRanking();
    }

    function hydrateSelects() {
      selDifficulty.innerHTML = `
        <option value="all">é›£æ˜“åº¦ï¼šã™ã¹ã¦</option>
        <option value="ã‹ã‚“ãŸã‚“">é›£æ˜“åº¦ï¼šã‹ã‚“ãŸã‚“</option>
        <option value="ãµã¤ã†">é›£æ˜“åº¦ï¼šãµã¤ã†</option>
        <option value="ã‚€ãšã‹ã—ã„">é›£æ˜“åº¦ï¼šã‚€ãšã‹ã—ã„</option>
      `;

      selCategory.innerHTML =
        `<option value="all">ã‚«ãƒ†ã‚´ãƒªï¼šã™ã¹ã¦</option>` +
        categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

      selTheme.innerHTML = `<option value="all">ãƒ†ãƒ¼ãƒï¼šã™ã¹ã¦</option>`;

      selRankScope.innerHTML = `
        <option value="overall">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šå…¨ä½“</option>
        <option value="category">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªï¼‰</option>
        <option value="theme">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šãƒ†ãƒ¼ãƒåˆ¥ï¼ˆç¾åœ¨ã®ãƒ†ãƒ¼ãƒï¼‰</option>
        <option value="daily">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ</option>
      `;
    }

    // ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ãƒ†ãƒ¼ãƒã ã‘è¡¨ç¤ºï¼ˆã‚«ãƒ†ã‚´ãƒª=ã™ã¹ã¦ãªã‚‰å…¨ãƒ†ãƒ¼ãƒï¼‰
    function applyThemeOptionsByCategory() {
      const daily = chkDailyTheme.checked && !!dailyTheme;
      if (daily) return;

      const cat = selCategory.value;
      const currentTheme = selTheme.value;

      let themes = [];
      if (cat === "all") {
        themes = allThemes;
      } else {
        const set = themeByCategory.get(cat);
        themes = set ? Array.from(set).sort((a,b) => a.localeCompare(b, "ja")) : [];
      }

      selTheme.innerHTML =
        `<option value="all">ãƒ†ãƒ¼ãƒï¼šã™ã¹ã¦</option>` +
        themes.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");

      selTheme.value = themes.includes(currentTheme) ? currentTheme : "all";
    }

    function getActiveFilters() {
      const daily = chkDailyTheme.checked && !!dailyTheme;
      const difficulty = selDifficulty.value;
      const category = daily ? "all" : selCategory.value;
      const theme = daily ? dailyTheme : selTheme.value;
      return { daily, difficulty, category, theme };
    }

    function filterPool() {
      const { daily, difficulty, category, theme } = getActiveFilters();
      return items.filter(x => {
        if (difficulty !== "all" && x.difficulty !== difficulty) return false;
        if (!daily && category !== "all" && x.category !== category) return false;
        if (theme !== "all" && x.theme !== theme) return false;
        return true;
      });
    }

    function pickNextItem(pool) {
      if (pool.length === 0) return null;
      const notRecent = pool.filter(x => !isRecentlyUsed(x.text));
      const candidates = (notRecent.length > 0) ? notRecent : pool;
      return candidates[Math.floor(Math.random() * candidates.length)];
    }

    // =========================
    // è¦‹æœ¬æ–‡ï¼šæ­£è§£é’ï¼èª¤ã‚Šèµ¤ï¼ˆæœ€åˆã®èª¤ã‚Šä»¥é™ã‚’èµ¤ã«å¯„ã›ã‚‹ï¼‰
    // =========================
    function renderTarget(typed) {
      const textEl = document.getElementById("text");
      const t = target ?? "";
      const v = typed ?? "";

      let mismatch = -1;
      const minLen = Math.min(v.length, t.length);
      for (let i = 0; i < minLen; i++) {
        if (v[i] !== t[i]) { mismatch = i; break; }
      }
      if (mismatch === -1 && v.length > t.length) mismatch = t.length;

      let html = "";
      if (mismatch === -1) {
        const okPart = t.slice(0, v.length);
        const rest = t.slice(v.length);
        html = `<span class="ok">${escapeHtml(okPart)}</span>${escapeHtml(rest)}`;
      } else {
        const okPart = t.slice(0, mismatch);
        const ngPart = t.slice(mismatch, Math.min(v.length, t.length));
        const rest = t.slice(Math.min(v.length, t.length));
        html = `<span class="ok">${escapeHtml(okPart)}</span><span class="ng">${escapeHtml(ngPart)}</span>${escapeHtml(rest)}`;
      }
      textEl.innerHTML = html;
    }

    function resetTypingState() {
      startTime = 0;
      ended = false;
      keystrokes = 0;
      submitBtn.disabled = true;
      submitBtn.dataset.wpm = "";
      submitBtn.dataset.cpm = "";
      submitBtn.dataset.kpm = "";
      submitBtn.dataset.rank = "";
      submitBtn.dataset.diff = "";
      document.getElementById("result").textContent = "";
    }

    function setNewText() {
      const pool = filterPool();
      if (pool.length === 0) {
        target = "";
        document.getElementById("text").textContent = "è©²å½“ã™ã‚‹æ–‡ç« ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚";
        inputBox.value = "";
        inputBox.disabled = true;
        resetTypingState();
        updateBadges(null);
        return;
      }

      const pick = pickNextItem(pool);
      target = pick.text;

      pushHistory(target);

      inputBox.disabled = false;
      inputBox.value = "";
      inputBox.focus();

      resetTypingState();
      renderTarget("");

      updateBadges(pick);

      loadDailyRanking();
      loadRanking();
    }

    function updateDailyThemeUI() {
      const daily = chkDailyTheme.checked && !!dailyTheme;
      selCategory.disabled = daily;
      selTheme.disabled = daily;

      if (dailyTheme) {
        dailyInfoEl.textContent = `ä»Šæ—¥ï¼ˆ${todayKey()}ï¼‰ã®ãƒ†ãƒ¼ãƒï¼š${dailyTheme}` + (daily ? "ï¼ˆå›ºå®šä¸­ï¼‰" : "");
        dailyInfoEl.style.display = "block";
      } else {
        dailyInfoEl.textContent = "";
        dailyInfoEl.style.display = "none";
      }
    }

    function updateBadges(pickItem) {
      const { daily, difficulty, category, theme } = getActiveFilters();
      const badges = [];

      badges.push(daily ? `æ—¥æ›¿ã‚ã‚Šï¼šONï¼ˆ${dailyTheme ?? "â€”"}ï¼‰` : "æ—¥æ›¿ã‚ã‚Šï¼šOFF");
      badges.push(`é›£æ˜“åº¦è¨­å®šï¼š${difficulty === "all" ? "ã™ã¹ã¦" : difficulty}`);
      badges.push(`ã‚«ãƒ†ã‚´ãƒªï¼š${daily ? "â€”" : (category === "all" ? "ã™ã¹ã¦" : category)}`);
      badges.push(`ãƒ†ãƒ¼ãƒï¼š${theme === "all" ? "ã™ã¹ã¦" : theme}`);

      // è¦æœ›ï¼šå•é¡Œæ•°ã¯éè¡¨ç¤º
      if (pickItem) {
        const kataPct = Math.round(pickItem.kataRatio * 100);
        badges.push(`å‡ºé¡Œé›£æ˜“åº¦ï¼š${pickItem.difficulty}`);
        badges.push(`æ–‡å­—æ•°ï¼š${pickItem.length}`);
        badges.push(`å¥èª­ç‚¹ï¼š${pickItem.punct}`);
        badges.push(`ã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡ï¼š${kataPct}%`);
      }

      badgesEl.innerHTML = badges.map(b => `<span class="pill">${escapeHtml(b)}</span>`).join("");
      updateRankingLabels();
    }

    // =========================
    // Ranking boards (è£åˆ†å²)
    // =========================
    function getRankingKey(scope) {
      const { daily, difficulty, category, theme } = getActiveFilters();
      const diffKey = (difficulty === "all") ? "diff_all" : `diff_${difficulty}`;

      if (scope === "overall") return `rk_overall__${diffKey}`;
      if (scope === "daily") {
        const t = dailyTheme ?? "no_theme";
        return `rk_daily__${toSafeKey(t)}__${diffKey}`;
      }
      if (scope === "category") {
        const c = daily ? "all" : category;
        return `rk_category__${toSafeKey(c)}__${diffKey}`;
      }
      if (scope === "theme") {
        const t = (theme === "all") ? "all" : theme;
        return `rk_theme__${toSafeKey(t)}__${diffKey}`;
      }
      return `rk_overall__${diffKey}`;
    }
    function getCollectionNameByScope(scope) {
      return `scores__${toSafeKey(getRankingKey(scope))}`;
    }

    function updateRankingLabels() {
      const { daily, difficulty, category, theme } = getActiveFilters();
      const diffText = (difficulty === "all") ? "ï¼ˆé›£æ˜“åº¦ï¼šã™ã¹ã¦ï¼‰" : `ï¼ˆé›£æ˜“åº¦ï¼š${difficulty}ï¼‰`;

      dailyRankLabel.textContent = `ğŸ† ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã€Œ${dailyTheme ?? "â€”"}ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10 ${diffText}`;

      const scope = selRankScope.value;
      let label = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°";
      if (scope === "overall") label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šå…¨ä½“ TOP10 ${diffText}`;
      if (scope === "daily") label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã€Œ${dailyTheme ?? "â€”"}ã€TOP10 ${diffText}`;
      if (scope === "category") {
        const c = daily ? "â€”" : (category === "all" ? "ã™ã¹ã¦" : category);
        label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šã‚«ãƒ†ã‚´ãƒªã€Œ${c}ã€TOP10 ${diffText}`;
      }
      if (scope === "theme") {
        const t = (theme === "all") ? "ã™ã¹ã¦" : theme;
        label = `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼šãƒ†ãƒ¼ãƒã€Œ${t}ã€TOP10 ${diffText}`;
      }
      rankLabel.textContent = label;
    }

    async function loadDailyRanking() {
      const list = document.getElementById("dailyRanking");
      list.innerHTML = "";

      const colName = getCollectionNameByScope("daily");
      try {
        const q = query(collection(db, colName), orderBy("wpm", "desc"), limit(10));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          const li = document.createElement("li");
          li.textContent = "ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚";
          list.appendChild(li);
          return;
        }
        snapshot.forEach(docu => {
          const d = docu.data();
          const li = document.createElement("li");
          li.textContent = `${d.name} - ${d.wpm} WPM`;
          list.appendChild(li);
        });
      } catch {
        const li = document.createElement("li");
        li.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        list.appendChild(li);
      }
    }

    async function loadRanking() {
      const list = document.getElementById("ranking");
      list.innerHTML = "";

      const scope = selRankScope.value;
      const colName = getCollectionNameByScope(scope);
      try {
        const q = query(collection(db, colName), orderBy("wpm", "desc"), limit(10));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          const li = document.createElement("li");
          li.textContent = "ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚";
          list.appendChild(li);
          return;
        }
        snapshot.forEach(docu => {
          const d = docu.data();
          const li = document.createElement("li");
          li.textContent = `${d.name} - ${d.wpm} WPM`;
          list.appendChild(li);
        });
      } catch {
        const li = document.createElement("li");
        li.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        list.appendChild(li);
      }
    }

    async function saveScoreToMultipleBoards({ name, wpm }) {
      const targets = ["overall", "daily", "category", "theme"].map(scope => {
        const colName = getCollectionNameByScope(scope);
        return addDoc(collection(db, colName), { name, wpm, timestamp: serverTimestamp() });
      });
      await Promise.allSettled(targets);
    }

    // =========================
    // Metrics (CPM/KPM + Rank)
    // =========================
    function computeMetrics(typed, seconds, ks) {
      const minutes = seconds / 60;
      const cpm = Math.round(typed.length / minutes);
      const kpm = Math.round(ks / minutes);
      const wpm = Math.round((typed.length / 5) / minutes); // å‚è€ƒ
      const diff = Math.max(0, kpm - cpm);
      const eff = (kpm > 0) ? (cpm / kpm) : 0;
      const rank = calcRank(cpm, kpm);
      return { cpm, kpm, wpm, diff, eff, rank };
    }

    // =========================
    // User history (subcollection users/{uid}/histories)
    // - é›£æ˜“åº¦åˆ¥TOPï¼ˆCPM & Rankï¼‰
    // - diffæ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆKPM-CPMï¼‰
    // - ä»Šæ—¥ vs éå»7æ—¥å¹³å‡
    // =========================
    function historiesRef(uid) {
      return collection(db, `users/${uid}/histories`);
    }

    async function ensureUserDoc(uid) {
      try {
        await setDoc(doc(db, "users", uid), {
          createdAt: serverTimestamp()
        }, { merge: true });
      } catch { /* noop */ }
    }

    function avg(arr) {
      if (!arr.length) return null;
      return Math.round(arr.reduce((s, x) => s + x, 0) / arr.length);
    }

    function formatCompare(todayObj, avg7Obj) {
      const el = document.getElementById("compareToday");
      if (!todayObj || !avg7Obj) {
        el.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå±¥æ­´ã‚’æ•°å›ä¿å­˜ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰ã€‚";
        return;
      }
      const cpmDelta = todayObj.cpm - avg7Obj.cpm;
      const kpmDelta = todayObj.kpm - avg7Obj.kpm;
      const effDelta = Math.round((todayObj.eff - avg7Obj.eff) * 1000) / 10; // %
      const sign = (n) => (n > 0 ? `+${n}` : `${n}`);

      el.innerHTML =
        `ä»Šæ—¥ï¼šCPM ${todayObj.cpm} / KPM ${todayObj.kpm} / ãƒ©ãƒ³ã‚¯ ${todayObj.rank} / åŠ¹ç‡ ${(todayObj.eff*100).toFixed(1)}%<br>` +
        `éå»7æ—¥å¹³å‡ï¼šCPM ${avg7Obj.cpm} / KPM ${avg7Obj.kpm} / ãƒ©ãƒ³ã‚¯ ${avg7Obj.rank} / åŠ¹ç‡ ${(avg7Obj.eff*100).toFixed(1)}%<br>` +
        `å·®åˆ†ï¼šCPM ${sign(cpmDelta)} / KPM ${sign(kpmDelta)} / åŠ¹ç‡ ${sign(effDelta)}%`;
    }

    function drawDiffChart(values) {
      const canvas = document.getElementById("diffChart");
      const ctx = canvas.getContext("2d");

      // é«˜DPIå¯¾ç­–
      const cssW = canvas.clientWidth;
      const cssH = canvas.clientHeight;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      ctx.clearRect(0, 0, cssW, cssH);

      if (!values.length) {
        ctx.fillText("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", 10, 20);
        return;
      }

      const pad = 24;
      const w = cssW - pad * 2;
      const h = cssH - pad * 2;

      const maxV = Math.max(...values, 10);
      const minV = Math.min(...values, 0);

      // è»¸
      ctx.strokeStyle = "#ddd";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, pad + h);
      ctx.lineTo(pad + w, pad + h);
      ctx.stroke();

      // ç·š
      ctx.strokeStyle = "#0b5ed7";
      ctx.lineWidth = 2;
      ctx.beginPath();

      const n = values.length;
      for (let i = 0; i < n; i++) {
        const x = pad + (n === 1 ? 0 : (i / (n - 1)) * w);
        const norm = (values[i] - minV) / (maxV - minV || 1);
        const y = pad + h - norm * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // ãƒ©ãƒ™ãƒ«ï¼ˆç°¡æ˜“ï¼‰
      ctx.fillStyle = "#555";
      ctx.font = "12px system-ui";
      ctx.fillText("KPMâˆ’CPM å·®ï¼ˆå°ã•ã„ã»ã©åŠ¹ç‡çš„ï¼‰", pad, 14);
    }

    function renderBestByDifficulty(histories) {
      const el = document.getElementById("bestByDifficulty");
      el.innerHTML = "";

      const diffs = ["ã‹ã‚“ãŸã‚“", "ãµã¤ã†", "ã‚€ãšã‹ã—ã„"];
      const best = {};
      for (const d of diffs) best[d] = { bestCpm: null, bestRank: "D", bestKpm: null };

      for (const h of histories) {
        const d = h.difficulty;
        if (!best[d]) continue;

        if (best[d].bestCpm === null || h.cpm > best[d].bestCpm) {
          best[d].bestCpm = h.cpm;
          best[d].bestKpm = h.kpm;
        }
        best[d].bestRank = betterRank(h.rank, best[d].bestRank);
      }

      for (const d of diffs) {
        const li = document.createElement("li");
        if (best[d].bestCpm === null) {
          li.textContent = `${d}ï¼šã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“`;
        } else {
          li.textContent = `${d}ï¼šTOP CPM ${best[d].bestCpm}ï¼ˆKPM ${best[d].bestKpm}ï¼‰ / TOPãƒ©ãƒ³ã‚¯ ${best[d].bestRank}`;
        }
        el.appendChild(li);
      }
    }

    function renderRecent(histories) {
      const ul = document.getElementById("myRecent");
      ul.innerHTML = "";
      const slice = histories.slice(0, 12);
      if (!slice.length) {
        const li = document.createElement("li");
        li.textContent = "ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¹ã‚³ã‚¢é€ä¿¡ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚";
        ul.appendChild(li);
        return;
      }
      for (const h of slice) {
        const li = document.createElement("li");
        li.textContent = `${h.dateKey}ï½œ${h.difficulty}ï½œCPM ${h.cpm} / KPM ${h.kpm}ï½œãƒ©ãƒ³ã‚¯ ${h.rank}ï½œå·® ${h.diff}`;
        ul.appendChild(li);
      }
    }

    function summarizeToday(histories) {
      const tKey = todayKey();
      const todays = histories.filter(h => h.dateKey === tKey);
      if (!todays.length) return null;

      const cpm = avg(todays.map(h => h.cpm));
      const kpm = avg(todays.map(h => h.kpm));
      const eff = (kpm > 0) ? cpm / kpm : 0;
      const rank = calcRank(cpm, kpm);
      return { cpm, kpm, eff, rank };
    }

    function summarize7days(histories) {
      const now = new Date();
      const cutoff = now.getTime() - 7 * 24 * 60 * 60 * 1000;
      const last7 = histories.filter(h => h.createdAtMs !== null && h.createdAtMs >= cutoff);
      if (!last7.length) return null;

      const cpm = avg(last7.map(h => h.cpm));
      const kpm = avg(last7.map(h => h.kpm));
      const eff = (kpm > 0) ? cpm / kpm : 0;
      const rank = calcRank(cpm, kpm);
      return { cpm, kpm, eff, rank };
    }

    async function loadMyHistoryAndAnalytics(uid) {
      const q = query(historiesRef(uid), orderBy("createdAt", "desc"), limit(300));
      const snap = await getDocs(q);

      const histories = [];
      snap.forEach(docu => {
        const d = docu.data();
        const ts = d.createdAt;
        const ms = ts && typeof ts.toMillis === "function" ? ts.toMillis() : null;
        histories.push({
          dateKey: d.dateKey ?? "",
          difficulty: d.difficulty ?? "",
          category: d.category ?? "",
          theme: d.theme ?? "",
          cpm: Number(d.cpm ?? 0),
          kpm: Number(d.kpm ?? 0),
          wpm: Number(d.wpm ?? 0),
          diff: Number(d.diff ?? 0),
          eff: Number(d.eff ?? 0),
          rank: d.rank ?? "D",
          createdAtMs: ms
        });
      });

      // UI: recent + best by difficulty
      renderRecent(histories);
      renderBestByDifficulty(histories);

      // diff chart: æ™‚ç³»åˆ—ï¼ˆå¤ã„â†’æ–°ã—ã„ï¼‰ã§æœ€å¾Œ30ä»¶
      const diffSeries = histories
        .slice(0, 60)
        .reverse()
        .map(h => h.diff);
      drawDiffChart(diffSeries.slice(-30));

      // ä»Šæ—¥ vs éå»7æ—¥å¹³å‡
      const today = summarizeToday(histories);
      const avg7 = summarize7days(histories);
      formatCompare(today, avg7);
    }

    async function saveHistory(uid, record) {
      await addDoc(historiesRef(uid), {
        ...record,
        createdAt: serverTimestamp()
      });
    }

    // =========================
    // Main
    // =========================
    window.addEventListener("DOMContentLoaded", async () => {
      selDifficulty = document.getElementById("difficulty");
      selCategory = document.getElementById("category");
      selTheme = document.getElementById("theme");
      chkDailyTheme = document.getElementById("dailyTheme");
      selRankScope = document.getElementById("rankScope");

      rankLabel = document.getElementById("rankLabel");
      dailyRankLabel = document.getElementById("dailyRankLabel");
      dailyInfoEl = document.getElementById("dailyInfo");
      badgesEl = document.getElementById("modeBadges");

      inputBox = document.getElementById("input");
      submitBtn = document.getElementById("submitBtn");
      skipBtn = document.getElementById("skipBtn");

      userBadgeEl = document.getElementById("userBadge");

      // Controls
      selDifficulty.addEventListener("change", () => setNewText());

      selCategory.addEventListener("change", () => {
        applyThemeOptionsByCategory();
        setNewText();
      });

      selTheme.addEventListener("change", () => setNewText());

      chkDailyTheme.addEventListener("change", () => {
        updateDailyThemeUI();
        applyThemeOptionsByCategory();
        setNewText();
      });

      selRankScope.addEventListener("change", () => {
        updateRankingLabels();
        loadRanking();
      });

      // ã€Œåˆ¥ã®æ–‡ç« ã«ã™ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆè¦‹æœ¬æ–‡ã®ä¸Šï¼‰
      skipBtn.addEventListener("click", () => setNewText());

      // Load JSON
      try {
        await loadItems();
      } catch {
        document.getElementById("text").textContent =
          "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚data/trivia.json ã®ç½®ãå ´æ‰€ã¨JSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        inputBox.disabled = true;
        return;
      }

      // Auth ready -> load analytics
      onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        await ensureUserDoc(user.uid);
        userBadgeEl.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼š${user.uid.slice(0, 8)}â€¦ï¼ˆã“ã®ç«¯æœ«ã§å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã™ï¼‰`;
        try {
          await loadMyHistoryAndAnalytics(user.uid);
        } catch {
          // noop
        }
      });

      // KPMå¼·åŒ–ã‚«ã‚¦ãƒ³ãƒˆï¼ˆIMEå¯„ã‚Šï¼‰
      inputBox.addEventListener("keydown", (e) => {
        const k = e.key;
        const isPrintable = (k.length === 1);
        const isEdit = (k === "Backspace" || k === "Delete");
        const isImeOps = (k === " " || k === "Enter"); // Space=å¤‰æ› / Enter=ç¢ºå®š
        if (isPrintable || isEdit || isImeOps) keystrokes++;
      });

      // Typing: live render + finish
      inputBox.addEventListener("input", () => {
        const typed = inputBox.value;

        renderTarget(typed);

        if (typed.length === 1 && startTime === 0 && target) {
          startTime = Date.now();
          keystrokes = 0; // é–‹å§‹å‰ã®ã‚­ãƒ¼ã‚’é™¤å¤–
        }

        if (!ended && typed === target) {
          ended = true;
          const seconds = (Date.now() - startTime) / 1000;
          const { cpm, kpm, wpm, diff, eff, rank } = computeMetrics(typed, seconds, keystrokes);

          const effPct = (eff * 100).toFixed(1);
          document.getElementById("result").innerHTML =
            `å®Œäº†ï¼<br>` +
            `<strong>ãƒ©ãƒ³ã‚¯:</strong> ${rank}ï¼ˆåŠ¹ç‡ ${effPct}%ï¼‰<br>` +
            `<strong>CPMï¼ˆæ–‡å­—/åˆ†ï¼‰:</strong> ${cpm}<br>` +
            `<strong>KPMï¼ˆæ‰“éµ/åˆ†ï¼‰:</strong> ${kpm}ï¼ˆSpace/Enterã§ã®å¤‰æ›ãƒ»ç¢ºå®šã‚’å«ã‚€ï¼‰<br>` +
            `<strong>KPMâˆ’CPMå·®:</strong> ${diff}<br>` +
            `<strong>å‚è€ƒWPM:</strong> ${wpm}`;

          submitBtn.disabled = false;

          // submitç”¨ã«ä¿æŒ
          submitBtn.dataset.wpm = String(wpm);
          submitBtn.dataset.cpm = String(cpm);
          submitBtn.dataset.kpm = String(kpm);
          submitBtn.dataset.rank = String(rank);
          submitBtn.dataset.diff = String(diff);
          submitBtn.dataset.eff = String(eff);
        }
      });

      // Submit: ãƒ©ãƒ³ã‚­ãƒ³ã‚° + å€‹äººå±¥æ­´
      submitBtn.addEventListener("click", async () => {
        const name = document.getElementById("name").value.trim();
        const wpm = parseInt(submitBtn.dataset.wpm, 10);
        const cpm = parseInt(submitBtn.dataset.cpm, 10);
        const kpm = parseInt(submitBtn.dataset.kpm, 10);
        const diff = parseInt(submitBtn.dataset.diff, 10);
        const eff = parseFloat(submitBtn.dataset.eff);
        const rank = submitBtn.dataset.rank;

        if (!name || Number.isNaN(wpm) || Number.isNaN(cpm) || Number.isNaN(kpm)) {
          alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }
        const user = auth.currentUser;
        if (!user) {
          alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®æº–å‚™ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
          return;
        }

        // ç¾åœ¨ã®æ¡ä»¶
        const { daily, difficulty, category, theme } = getActiveFilters();
        // å‡ºé¡Œå´ã®é›£æ˜“åº¦ã¯ target ã®æ–‡ã‹ã‚‰å†æ¨å®šã—ãªã„ï¼ˆè»½é‡åŒ–ï¼‰
        // difficulty ã¯ã€Œãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã€ã‚’ä¿å­˜ï¼ˆå®Ÿå‹™é‹ç”¨ã§åˆ†ã‹ã‚Šã‚„ã™ã„ï¼‰
        const record = {
          uid: user.uid,
          displayName: name,
          dateKey: todayKey(),
          difficulty: (difficulty === "all" ? "ï¼ˆã™ã¹ã¦ï¼‰" : difficulty),
          category: (daily ? "ï¼ˆæ—¥æ›¿ã‚ã‚Šï¼‰" : (category === "all" ? "ï¼ˆã™ã¹ã¦ï¼‰" : category)),
          theme: (theme === "all" ? "ï¼ˆã™ã¹ã¦ï¼‰" : theme),
          cpm, kpm, wpm, diff,
          eff: Math.round(eff * 10000) / 10000,
          rank,
          length: target.length
        };

        try {
          await saveScoreToMultipleBoards({ name, wpm });
          await saveHistory(user.uid, record);

          await loadDailyRanking();
          await loadRanking();
          await loadMyHistoryAndAnalytics(user.uid);

          setNewText();
        } catch {
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreè¨­å®šã‚„æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      });

      // First
      updateRankingLabels();
      setNewText();
    });

    // ãƒšãƒ¼ã‚¸å†…ã§ãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸæ™‚ã‚‚ã‚°ãƒ©ãƒ•ã‚’æãç›´ã—ãŸã„ï¼ˆå¿…è¦æœ€å°é™ï¼‰
    window.addEventListener("resize", () => {
      // æ¬¡ã®å±¥æ­´æ›´æ–°æ™‚ã«å†æç”»ã•ã‚Œã‚‹ãŒã€å³æ™‚ã‚‚å¿…è¦ãªã‚‰ã“ã“ã§å†å–å¾—ãŒå¿…è¦
      // ã“ã“ã§ã¯æç”»ã®ã¿å³æ™‚å¯¾å¿œï¼ˆå€¤ã¯æœ€å¾Œã«æã„ãŸã‚‚ã®ã‚’ä¿æŒã—ãªã„ãŸã‚ç„¡æ“ä½œï¼‰
    });
  </script>
</head>

<body>
  <header>
    <h1>æ¼¢å­—å¤‰æ›å¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</h1>
    <p class="lead">
      é›‘å­¦ãƒ»è±†çŸ¥è­˜ã®æ–‡ç« ã§ã€æ¼¢å­—å¤‰æ›ã‚’å«ã‚€å®Ÿç”¨çš„ãªæ—¥æœ¬èªå…¥åŠ›ã‚’ç·´ç¿’ã§ãã¾ã™ã€‚
      é›£æ˜“åº¦ã¯ length ã«åŠ ãˆã¦ã€Œå¥èª­ç‚¹æ•°ã€ã€Œã‚«ã‚¿ã‚«ãƒŠæ¯”ç‡ã€ã‚‚è€ƒæ…®ã—ã¦ç²¾å¯†åŒ–ã—ã¦ã„ã¾ã™ã€‚
    </p>
    <p class="muted" id="userBadge">ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼šèª­ã¿è¾¼ã¿ä¸­â€¦</p>
  </header>

  <main>
    <section id="play" class="card" aria-label="ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’">
      <h2>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’</h2>

      <div class="row" style="margin-bottom:10px;">
        <select id="difficulty" aria-label="é›£æ˜“åº¦"></select>
        <select id="category" aria-label="ã‚«ãƒ†ã‚´ãƒª"></select>
        <select id="theme" aria-label="ãƒ†ãƒ¼ãƒ"></select>
        <label class="checkbox" title="ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã«å›ºå®šã—ã¾ã™ï¼ˆæ¯æ—¥å¤‰ã‚ã‚Šã¾ã™ï¼‰">
          <input type="checkbox" id="dailyTheme" />
          æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒ
        </label>
      </div>

      <p id="dailyInfo" class="muted" style="display:none; margin: 0 0 10px;"></p>
      <div id="modeBadges" style="margin: 0 0 10px;"></div>

      <!-- è¦æœ›ï¼šåˆ¥ã®æ–‡ç« ã«ã™ã‚‹ ã‚’è¦‹æœ¬æ–‡ã®ä¸Šã¸ -->
      <div class="row" style="margin: 0 0 6px;">
        <button id="skipBtn" type="button">åˆ¥ã®æ–‡ç« ã«ã™ã‚‹</button>
      </div>

      <p id="text">èª­ã¿è¾¼ã¿ä¸­...</p>

      <textarea id="input" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°" disabled></textarea>

      <div id="result"></div>

      <h3 style="margin-top:16px;">ã‚¹ã‚³ã‚¢é€ä¿¡ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‹å€‹äººå±¥æ­´ã«ä¿å­˜ï¼‰</h3>
      <div class="row">
        <input type="text" id="name" placeholder="ã‚ãªãŸã®åå‰" />
        <button id="submitBtn" disabled>ã‚¹ã‚³ã‚¢é€ä¿¡</button>
      </div>

      <div class="split" style="margin-top: 18px;">
        <div class="card" style="border-color:#eee;">
          <h3 style="margin-top:0;">ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
          <div class="muted" id="dailyRankLabel" style="margin-bottom: 8px;"></div>
          <ul id="dailyRanking"></ul>
        </div>

        <div class="card" style="border-color:#eee;">
          <h3 style="margin-top:0;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
          <div class="row" style="margin-top: 0;">
            <select id="rankScope" aria-label="ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¯„å›²"></select>
            <div id="rankLabel" class="muted"></div>
          </div>
          <ul id="ranking" style="margin-top: 10px;"></ul>
        </div>
      </div>

      <noscript>
        <p class="muted">ã“ã®ã‚²ãƒ¼ãƒ ã¯JavaScriptãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
      </noscript>
    </section>

    <section class="card" style="margin-top:16px;">
      <h2 style="margin-top:0;">ã‚ãªãŸã®å…¥åŠ›åˆ†æ</h2>

      <div class="split">
        <div>
          <h3>é›£æ˜“åº¦åˆ¥ãƒ™ã‚¹ãƒˆï¼ˆTOP CPM / TOPãƒ©ãƒ³ã‚¯ï¼‰</h3>
          <ul id="bestByDifficulty"></ul>

          <h3>ä»Šæ—¥ã®è‡ªåˆ† vs éå»7æ—¥å¹³å‡</h3>
          <div id="compareToday" class="muted">ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå±¥æ­´ã‚’æ•°å›ä¿å­˜ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰ã€‚</div>
        </div>

        <div>
          <h3>KPMâˆ’CPMå·®ã®æ¨ç§»ï¼ˆç›´è¿‘ï¼‰</h3>
          <canvas id="diffChart"></canvas>

          <h3>æœ€è¿‘ã®å±¥æ­´</h3>
          <ul id="myRecent"></ul>
        </div>
      </div>
    </section>

    <section style="margin-top: 16px;">
      <h2>ã‚ˆãã‚ã‚‹è³ªå•</h2>
      <details>
        <summary>åŒã˜æ–‡ç« ãŒä½•åº¦ã‚‚å‡ºã¾ã›ã‚“ã‹ï¼Ÿ</summary>
        <p>ç›´è¿‘10å•ã¯å†å‡ºé¡Œã•ã‚Œã«ãã„ã‚ˆã†ã«åˆ¶å¾¡ã—ã¦ã„ã¾ã™ï¼ˆå€™è£œãŒå°‘ãªã„å ´åˆã¯ä¾‹å¤–ï¼‰ã€‚</p>
      </details>
      <details>
        <summary>KPMã¯ä½•ã‚’æ•°ãˆã¦ã„ã¾ã™ã‹ï¼Ÿ</summary>
        <p>é€šå¸¸æ–‡å­—ãƒ»Backspace/Deleteã«åŠ ãˆã€Spaceï¼ˆå¤‰æ›ï¼‰ã¨Enterï¼ˆç¢ºå®šï¼‰ã‚‚æ‰“éµã¨ã—ã¦æ•°ãˆã¾ã™ã€‚æ—¥æœ¬èªIMEã®å®Ÿå‹™è² è·ã«å¯„ã›ãŸæŒ‡æ¨™ã§ã™ã€‚</p>
      </details>
      <details>
        <summary>ãƒ†ãƒ¼ãƒå€™è£œãŒå°‘ãªã„ã®ã¯ãªãœï¼Ÿ</summary>
        <p>é¸ã‚“ã ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ãƒ†ãƒ¼ãƒã ã‘ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ï¼ˆã‚«ãƒ†ã‚´ãƒªã‚’ã€Œã™ã¹ã¦ã€ã«ã™ã‚‹ã¨å…¨ãƒ†ãƒ¼ãƒãŒå‡ºã¾ã™ï¼‰ã€‚</p>
      </details>
    </section>
  </main>

  <footer>
    <p>Â© 2025</p>
  </footer>
</body>
</html>
